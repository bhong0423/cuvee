<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Cuv√©e">
<meta name="theme-color" content="#1a1208">
<link rel="apple-touch-icon" href="icon.svg">
<link rel="icon" type="image/svg+xml" href="icon.svg">
<title>Cuv√©e</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f7f4ef;
    --surface: #fefcf9;
    --surface-2: #f4f0e9;
    --border: #e2dbd0;
    --border-soft: #ece7de;
    --text: #1e1a16;
    --text-2: #3a342c;
    --muted: #9c9288;
    --muted-2: #bdb5aa;
    --accent: #8c4a2f;
    --accent-mid: #b05c38;
    --accent-light: #d4845a;
    --now: #3a6b4e;
    --now-bg: #eaf3ee;
    --mid: #2a527a;
    --mid-bg: #e8eff8;
    --long: #5c3870;
    --long-bg: #f0eaf5;
    --tag-bg: #ede8df;
    --gold: #b8924a;
    --gold-bg: #faf3e4;
    --shadow-sm: 0 1px 4px rgba(30,26,22,0.06);
    --shadow-md: 0 4px 20px rgba(30,26,22,0.09), 0 1px 4px rgba(30,26,22,0.04);
    --shadow-lg: 0 16px 48px rgba(30,26,22,0.13), 0 4px 10px rgba(30,26,22,0.06);
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { background:var(--bg); color:var(--text); font-family:'Outfit',sans-serif; font-weight:300; min-height:100vh; }

  /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
  header {
    background:var(--surface);
    border-bottom:1px solid var(--border);
    padding:0 52px;
    display:flex;
    justify-content:space-between;
    align-items:stretch;
    height:74px;
  }
  .header-left { display:flex; align-items:center; gap:40px; }
  .logo {
    font-family:'Cormorant Garamond',serif;
    font-size:28px;
    font-weight:300;
    letter-spacing:5px;
    text-transform:uppercase;
    color:var(--text);
  }
  .logo em { font-style:italic; color:var(--gold); }
  .header-divider { width:1px; background:var(--border); height:28px; align-self:center; }
  .header-stats { display:flex; gap:28px; align-items:center; }
  .hstat { display:flex; align-items:baseline; gap:5px; }
  .hstat-num { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:400; color:var(--text); line-height:1; }
  .hstat-label { font-size:10px; font-weight:400; color:var(--muted); letter-spacing:1.2px; text-transform:uppercase; }
  .hstat-sep { color:var(--border); font-size:14px; }
  .header-right { display:flex; align-items:center; }
  .btn-add {
    display:flex; align-items:center; gap:8px;
    background:var(--accent);
    color:#fefcf9;
    border:none; cursor:pointer;
    padding:0 20px;
    height:36px;
    border-radius:4px;
    font-family:'Outfit',sans-serif;
    font-size:11px;
    font-weight:500;
    letter-spacing:1.2px;
    text-transform:uppercase;
    transition:all 0.2s;
  }
  .btn-add:hover { background:var(--accent-mid); transform:translateY(-1px); box-shadow:var(--shadow-md); }
  .btn-add svg { flex-shrink:0; }

  /* ‚îÄ‚îÄ TAB BAR ‚îÄ‚îÄ */
  .tab-bar {
    background:var(--surface);
    border-bottom:1px solid var(--border);
    padding:0 52px;
    display:flex;
    gap:0;
  }
  .tab {
    padding:0 4px;
    margin:0 20px 0 0;
    font-size:11px;
    font-weight:400;
    color:var(--muted);
    cursor:pointer;
    border:none;
    border-bottom:1.5px solid transparent;
    background:none;
    font-family:'Outfit',sans-serif;
    height:46px;
    transition:all 0.18s;
    letter-spacing:1.5px;
    text-transform:uppercase;
  }
  .tab:hover { color:var(--text-2); }
  .tab.active { color:var(--text); border-bottom-color:var(--gold); font-weight:500; }

  /* ‚îÄ‚îÄ MOBILE TAB BAR (hidden on desktop) ‚îÄ‚îÄ */
  .mobile-tab-bar { display: none; }

  /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ  */
  .tab-panel { display:none; }
  .tab-panel.active { display:block; }

  /* ‚îÄ‚îÄ CELLAR ‚îÄ‚îÄ */
  .cellar-panel { padding:0 52px 80px; }
  .filters {
    padding:20px 0 16px;
    display:flex;
    gap:6px;
    flex-wrap:wrap;
    align-items:center;
    border-bottom:1px solid var(--border-soft);
    margin-bottom:32px;
  }
  .filter-label { font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--muted-2); margin-right:6px; font-weight:500; }
  .filter-btn {
    padding:5px 14px;
    background:transparent;
    border:1px solid var(--border);
    border-radius:2px;
    color:var(--muted);
    font-family:'Outfit',sans-serif;
    font-size:11px;
    font-weight:400;
    cursor:pointer;
    transition:all 0.15s;
    letter-spacing:0.8px;
    text-transform:uppercase;
  }
  .filter-btn:hover { border-color:var(--text-2); color:var(--text-2); }
  .filter-btn.active { background:var(--text); border-color:var(--text); color:#fefcf9; }

  /* ‚îÄ‚îÄ SECTIONS ‚îÄ‚îÄ */
  .window-section { margin-bottom:52px; }
  .section-header {
    display:flex;
    align-items:center;
    gap:12px;
    margin-bottom:20px;
    padding-bottom:16px;
    border-bottom:1px solid var(--border-soft);
  }
  .section-pip { width:5px; height:5px; border-radius:50%; flex-shrink:0; }
  .pip-now { background:var(--now); }
  .pip-mid { background:var(--mid); }
  .pip-long { background:var(--long); }
  .section-title { font-family:'Cormorant Garamond',serif; font-size:20px; font-weight:400; color:var(--text); letter-spacing:0.3px; }
  .section-range {
    font-size:12px;
    color:var(--muted);
    font-style:italic;
    font-family:'Cormorant Garamond',serif;
    margin-left:2px;
  }
  .section-count {
    font-size:10px;
    color:var(--muted-2);
    margin-left:auto;
    font-weight:400;
    letter-spacing:1px;
    text-transform:uppercase;
  }

  /* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
  .wines-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:10px; }

  /* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
  .wine-card {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:6px;
    padding:20px 22px;
    cursor:pointer;
    transition:border-color 0.2s, box-shadow 0.2s, transform 0.18s;
    position:relative;
  }
  .wine-card:hover { border-color:var(--muted-2); box-shadow:var(--shadow-md); transform:translateY(-1px); }
  .wine-card.expanded { border-color:var(--gold); box-shadow:var(--shadow-md); border-left:2px solid var(--gold); }
  .card-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:10px; }
  .wine-vintage {
    font-family:'Cormorant Garamond',serif;
    font-size:34px;
    color:var(--text);
    opacity:0.18;
    line-height:1;
    font-style:italic;
    font-weight:300;
    letter-spacing:-1px;
  }
  .wine-badge {
    font-size:9px;
    letter-spacing:1.2px;
    text-transform:uppercase;
    padding:3px 10px;
    border-radius:2px;
    font-weight:500;
  }
  .badge-cab { background:#f5ebe4; color:#7a3010; }
  .badge-pinot { background:#f0eaf5; color:#5c3870; }
  .badge-chard { background:#f5f0e0; color:#6a5610; }
  .badge-blend { background:#e8f0f5; color:#2a527a; }
  .wine-producer { font-size:9px; letter-spacing:2.5px; text-transform:uppercase; color:var(--muted); margin-bottom:5px; font-weight:500; }
  .wine-name { font-family:'Cormorant Garamond',serif; font-size:18px; color:var(--text); line-height:1.3; margin-bottom:6px; font-weight:400; }
  .special-dot { display:inline-block; width:4px; height:4px; border-radius:50%; background:var(--gold); margin-left:7px; vertical-align:middle; margin-bottom:2px; }
  .wine-region-tag { font-size:11px; color:var(--muted); font-weight:400; font-style:italic; font-family:'Cormorant Garamond',serif; }
  .card-footer { display:flex; align-items:center; gap:8px; margin-top:14px; }
  .card-footer .drink-pill { flex:1; }
  .card-remove-btn {
    width:26px; height:26px; border-radius:4px;
    border:1px solid var(--border);
    background:none; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    color:var(--muted-2); transition:all 0.15s; flex-shrink:0;
  }
  .card-remove-btn:hover { border-color:#cc3333; color:#cc3333; background:#fff8f8; }
  .drink-pill {
    font-size:12px;
    color:var(--muted);
    font-style:italic;
    font-family:'Cormorant Garamond',serif;
  }
  .expand-icon {
    color:var(--muted-2);
    font-size:11px;
    transition:transform 0.3s;
    line-height:1;
  }
  .wine-card.expanded .expand-icon { transform:rotate(180deg); }

  /* ‚îÄ‚îÄ EXPANDED ‚îÄ‚îÄ */
  .wine-details { max-height:0; overflow:hidden; transition:max-height 0.4s cubic-bezier(0.4,0,0.2,1), opacity 0.3s; opacity:0; }
  .wine-card.expanded .wine-details { max-height:800px; opacity:1; margin-top:18px; }
  .detail-divider { height:1px; background:var(--border-soft); margin-bottom:18px; }
  .detail-label { font-size:9px; letter-spacing:2.5px; text-transform:uppercase; color:var(--muted-2); margin-bottom:8px; font-weight:500; }
  .detail-text { font-size:13px; line-height:1.85; color:var(--text-2); margin-bottom:18px; }
  .ratings-row { display:flex; flex-wrap:wrap; gap:6px; margin-bottom:18px; }
  .rating-chip {
    display:flex; align-items:baseline; gap:6px;
    background:var(--gold-bg);
    border-radius:3px; padding:6px 12px;
    border:1px solid rgba(184,146,74,0.2);
  }
  .rating-score { font-family:'Cormorant Garamond',serif; font-size:20px; color:var(--text); font-weight:500; }
  .rating-source { font-size:10px; color:var(--muted); font-weight:400; letter-spacing:0.3px; }
  .drink-row { display:flex; align-items:center; gap:10px; padding-top:14px; border-top:1px solid var(--border-soft); }
  .drink-label { font-size:9px; letter-spacing:2.5px; text-transform:uppercase; color:var(--muted-2); font-weight:500; }
  .drink-range { font-family:'Cormorant Garamond',serif; font-size:15px; color:var(--text); font-style:italic; }
  /* qty stepper on cards */
  .card-qty {
    display:flex; align-items:center; gap:7px;
    margin-top:10px;
  }
  .card-qty-label { font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--muted-2); font-weight:500; }
  .card-qty-controls { display:flex; align-items:center; gap:6px; }
  .card-qty-btn {
    width:24px; height:24px; border-radius:6px;
    border:1px solid var(--border);
    background:none; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    color:var(--muted); font-size:13px; line-height:1;
    transition:all 0.15s;
  }
  .card-qty-btn:hover { border-color:var(--text); color:var(--text); }
  .card-qty-num { font-size:14px; font-weight:400; min-width:18px; text-align:center; font-family:'Cormorant Garamond',serif; }

  .delete-btn {
    display:flex; align-items:center; gap:5px;
    background:none; border:1px solid var(--border);
    color:var(--muted); font-family:'Outfit',sans-serif;
    font-size:11px; font-weight:400;
    padding:5px 12px; border-radius:100px;
    cursor:pointer; transition:all 0.15s;
    margin-top:12px;
    letter-spacing:0.2px;
  }
  .delete-btn:hover { border-color:#cc3333; color:#cc3333; }

  /* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
  .map-panel { padding:40px 52px 80px; }
  .map-intro { max-width:560px; margin-bottom:28px; }
  .map-intro h2 { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:400; margin-bottom:6px; }
  .map-intro p { font-size:13px; color:var(--muted); line-height:1.7; }
  .map-wrap { background:var(--surface); border:1px solid var(--border); border-radius:14px; overflow:hidden; max-width:860px; box-shadow:var(--shadow-sm); }
  .cellar-map { width:100%; height:auto; display:block; }
  .map-legend { display:flex; gap:20px; padding:14px 20px; border-top:1px solid var(--border); background:var(--surface-2); flex-wrap:wrap; }
  .legend-item { display:flex; align-items:center; gap:7px; font-size:12px; color:var(--muted); }
  .legend-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }

  /* ‚îÄ‚îÄ ADD MODAL ‚îÄ‚îÄ */
  .modal-overlay {
    display:none;
    position:fixed; inset:0;
    background:rgba(28,24,20,0.45);
    backdrop-filter:blur(4px);
    z-index:1000;
    align-items:center;
    justify-content:center;
    padding:20px;
  }
  .modal-overlay.open { display:flex; animation:fadeIn 0.2s ease; }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  .modal {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:8px;
    width:100%;
    max-width:680px;
    max-height:90vh;
    overflow-y:auto;
    box-shadow:var(--shadow-lg);
    animation:slideUp 0.25s cubic-bezier(0.4,0,0.2,1);
  }
  @keyframes slideUp { from{transform:translateY(16px);opacity:0} to{transform:translateY(0);opacity:1} }
  .modal-header {
    padding:28px 32px 20px;
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    border-bottom:1px solid var(--border-soft);
  }
  .modal-title { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:400; }
  .modal-subtitle { font-size:12px; color:var(--muted); margin-top:3px; }
  .modal-close {
    width:30px; height:30px;
    border-radius:4px;
    border:1px solid var(--border);
    background:none;
    cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    color:var(--muted);
    transition:all 0.15s;
    flex-shrink:0;
    font-size:14px;
    line-height:1;
  }
  .modal-close:hover { border-color:var(--text); color:var(--text); }
  .modal-body { padding:28px 32px; }
  
  /* Search area */
  .search-section { margin-bottom:24px; }
  .search-label { font-size:9px; letter-spacing:2.5px; text-transform:uppercase; color:var(--muted); margin-bottom:8px; font-weight:500; display:block; }
  .search-row { display:flex; gap:8px; }
  .search-input {
    flex:1;
    height:42px;
    border:1px solid var(--border);
    border-radius:4px;
    padding:0 16px;
    font-family:'Outfit',sans-serif;
    font-size:13px;
    font-weight:300;
    color:var(--text);
    background:var(--surface);
    transition:border-color 0.15s;
    outline:none;
  }
  .search-input:focus { border-color:var(--gold); }
  .search-input::placeholder { color:var(--muted-2); }
  .btn-search {
    height:42px;
    padding:0 20px;
    background:var(--text);
    color:#fefcf9;
    border:none;
    border-radius:4px;
    font-family:'Outfit',sans-serif;
    font-size:12px;
    font-weight:500;
    cursor:pointer;
    transition:all 0.15s;
    white-space:nowrap;
    display:flex; align-items:center; gap:6px;
    letter-spacing:0.5px;
  }
  .btn-search:hover { background:var(--accent); }
  .btn-search:disabled { opacity:0.5; cursor:not-allowed; }
  .btn-search.loading { opacity:0.8; }

  /* Preview card */
  .wine-preview {
    background:var(--surface-2);
    border:1px solid var(--border);
    border-radius:12px;
    padding:0;
    overflow:hidden;
    margin-bottom:24px;
    display:none;
  }
  .wine-preview.visible { display:block; animation:fadeIn 0.25s; }
  .preview-header {
    padding:20px 24px;
    border-bottom:1px solid var(--border-soft);
    display:flex;
    justify-content:space-between;
    align-items:flex-start;
    gap:16px;
  }
  .preview-vintage { font-family:'Cormorant Garamond',serif; font-size:42px; font-weight:300; color:var(--text); opacity:0.12; line-height:1; font-style:italic; position:absolute; right:24px; top:20px; }
  .preview-meta { position:relative; }
  .preview-producer { font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--muted); margin-bottom:4px; font-weight:500; }
  .preview-name { font-family:'Cormorant Garamond',serif; font-size:20px; font-weight:400; color:var(--text); margin-bottom:4px; }
  .preview-region { font-size:12px; color:var(--muted); }
  .preview-badge { font-size:10px; letter-spacing:0.8px; text-transform:uppercase; padding:4px 12px; border-radius:100px; font-weight:500; flex-shrink:0; align-self:flex-start; }
  .preview-body { padding:20px 24px; }
  .preview-section { margin-bottom:16px; }
  .preview-section:last-child { margin-bottom:0; }
  .preview-notes { font-size:13px; line-height:1.8; color:var(--text-2); }
  .preview-ratings { display:flex; flex-wrap:wrap; gap:6px; margin-top:4px; }
  .preview-drink { font-family:'Cormorant Garamond',serif; font-size:16px; font-style:italic; color:var(--text); }
  .ai-tag {
    display:inline-flex; align-items:center; gap:4px;
    font-size:10px; color:var(--accent-light);
    background:#fef5f0; border:1px solid #f0d8c8;
    padding:2px 8px; border-radius:100px;
    margin-left:8px; vertical-align:middle;
    letter-spacing:0.3px; font-weight:500;
  }

  /* Form section */
  .form-section { border-top:1px solid var(--border-soft); padding-top:24px; }
  .form-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:12px; }
  .form-group { display:flex; flex-direction:column; gap:6px; }
  .form-group.full { grid-column:1/-1; }
  .form-label { font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--muted); font-weight:500; }
  .form-input, .form-select, .form-textarea {
    border:1px solid var(--border);
    border-radius:4px;
    padding:10px 14px;
    font-family:'Outfit',sans-serif;
    font-size:13px;
    font-weight:300;
    color:var(--text);
    background:var(--surface);
    transition:border-color 0.15s;
    outline:none;
  }
  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color:var(--gold); }
  .form-input::placeholder, .form-textarea::placeholder { color:var(--muted-2); }
  .form-select { appearance:none; background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%239a948c' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E"); background-repeat:no-repeat; background-position:right 14px center; padding-right:36px; cursor:pointer; }
  .form-textarea { min-height:80px; resize:vertical; line-height:1.6; }
  .modal-footer {
    padding:20px 32px 28px;
    display:flex;
    gap:8px;
    justify-content:flex-end;
    border-top:1px solid var(--border-soft);
  }
  .btn-cancel {
    height:40px; padding:0 20px;
    border:1px solid var(--border);
    background:none;
    color:var(--muted);
    border-radius:4px;
    font-family:'Outfit',sans-serif;
    font-size:12px; font-weight:400;
    letter-spacing:0.5px;
    cursor:pointer; transition:all 0.15s;
  }
  .btn-cancel:hover { border-color:var(--text); color:var(--text); }
  .btn-submit {
    height:40px; padding:0 24px;
    background:var(--accent);
    color:#fefcf9; border:none;
    border-radius:4px;
    font-family:'Outfit',sans-serif;
    font-size:12px; font-weight:500;
    letter-spacing:0.5px;
    cursor:pointer; transition:all 0.15s;
    display:flex; align-items:center; gap:6px;
  }
  .btn-submit:hover { background:var(--accent-mid); }
  .btn-submit:disabled { opacity:0.5; cursor:not-allowed; }

  /* Search status */
  .search-status { font-size:12px; color:var(--muted); margin-top:8px; min-height:18px; }
  .search-status.searching { color:var(--accent-light); }
  .search-status.found { color:var(--now); }
  .search-status.error { color:#cc3333; }

  /* Empty state */
  .empty-section {
    padding:48px 0;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    color:var(--muted-2);
    font-size:13px;
  }
  .empty-section svg { opacity:0.3; }

  /* ‚îÄ‚îÄ WISHLIST ‚îÄ‚îÄ */
  .wishlist-panel { padding:0 52px 80px; }
  .wishlist-intro {
    padding:24px 0 20px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-bottom:1px solid var(--border-soft);
    margin-bottom:28px;
  }
  .wishlist-intro-left h2 { font-family:'Cormorant Garamond',serif; font-size:20px; font-weight:400; }
  .wishlist-intro-left p { font-size:12px; color:var(--muted); margin-top:3px; }
  .wishlist-summary {
    display:flex; gap:20px; align-items:center;
    background:var(--surface-2);
    border:1px solid var(--border);
    border-radius:10px;
    padding:12px 20px;
  }
  .wsummary-item { text-align:center; }
  .wsummary-num { font-family:'Cormorant Garamond',serif; font-size:20px; font-weight:400; display:block; line-height:1; }
  .wsummary-label { font-size:10px; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted); margin-top:2px; display:block; font-weight:500; }
  .wsummary-sep { color:var(--border); font-size:18px; }

  /* Source group */
  .source-group { margin-bottom:36px; }
  .source-header {
    display:flex; align-items:center; gap:10px;
    margin-bottom:12px;
    padding-bottom:10px;
    border-bottom:1px solid var(--border-soft);
  }
  .source-label { font-size:9px; letter-spacing:2.5px; text-transform:uppercase; color:var(--muted); font-weight:500; }
  .source-name { font-family:'Cormorant Garamond',serif; font-size:17px; font-weight:400; }
  .source-count { font-size:11px; color:var(--muted-2); margin-left:auto; font-style:italic; font-family:'Cormorant Garamond',serif; }

  /* Wishlist rows */
  .wishlist-table { display:flex; flex-direction:column; gap:4px; }
  .wish-row {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:4px;
    padding:14px 18px;
    display:grid;
    grid-template-columns: 60px 1fr auto auto auto;
    align-items:center;
    gap:16px;
    transition:border-color 0.15s, box-shadow 0.15s;
  }
  .wish-row:hover { border-color:var(--muted-2); box-shadow:var(--shadow-sm); }
  .wish-vintage { font-family:'Cormorant Garamond',serif; font-size:22px; font-weight:300; font-style:italic; color:var(--text); opacity:0.35; line-height:1; }
  .wish-info { min-width:0; }
  .wish-name { font-family:'Cormorant Garamond',serif; font-size:15px; font-weight:400; color:var(--text); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .wish-sub { font-size:11px; color:var(--muted); margin-top:2px; display:flex; align-items:center; gap:8px; }
  .wish-badge { font-size:10px; letter-spacing:0.8px; text-transform:uppercase; padding:2px 8px; border-radius:100px; font-weight:500; flex-shrink:0; }
  .wish-price { font-family:'Cormorant Garamond',serif; font-size:16px; font-weight:400; color:var(--text); white-space:nowrap; text-align:right; }
  .wish-qty {
    display:flex; align-items:center; gap:8px;
  }
  .qty-btn {
    width:26px; height:26px; border-radius:6px;
    border:1px solid var(--border);
    background:none; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    color:var(--muted); font-size:14px; line-height:1;
    transition:all 0.15s; font-family:'Outfit',sans-serif;
  }
  .qty-btn:hover { border-color:var(--text); color:var(--text); }
  .qty-num { font-size:14px; font-weight:400; min-width:16px; text-align:center; }
  .wish-actions { display:flex; gap:6px; }
  .wish-btn {
    height:30px; padding:0 12px;
    border-radius:3px;
    font-family:'Outfit',sans-serif;
    font-size:11px; font-weight:500;
    cursor:pointer; transition:all 0.15s;
    white-space:nowrap;
    display:flex; align-items:center; gap:5px;
    letter-spacing:0.5px;
  }
  .wish-btn-add { background:var(--accent); color:#fefcf9; border:none; }
  .wish-btn-add:hover { background:var(--accent-mid); }
  .wish-btn-remove { background:none; color:var(--muted); border:1px solid var(--border); }
  .wish-btn-remove:hover { border-color:#cc3333; color:#cc3333; }

  .wishlist-empty {
    padding:60px 0;
    text-align:center;
    color:var(--muted-2);
    font-size:13px;
  }
  .wishlist-empty p { margin-top:8px; }

  /* ‚îÄ‚îÄ MAILING LISTS ‚îÄ‚îÄ */
  .lists-section {
    padding:24px 0 32px;
    border-bottom:1px solid var(--border-soft);
    margin-bottom:32px;
  }
  .lists-header {
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:16px;
  }
  .lists-title { font-family:'Cormorant Garamond',serif; font-size:18px; font-weight:400; }
  .lists-subtitle { font-size:11px; color:var(--muted); margin-top:2px; }

  .lists-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); gap:10px; }

  .list-card {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:6px;
    padding:20px 22px;
    position:relative;
    overflow:hidden;
    transition:box-shadow 0.2s, border-color 0.2s;
  }
  .list-card:hover { box-shadow:var(--shadow-sm); border-color:var(--muted-2); }
  .list-card.active-list { border-color:var(--border); }
  .list-card.watching-list { opacity:0.75; border-style:dashed; }
  .list-card-top { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom:10px; }
  .list-producer { font-family:'Cormorant Garamond',serif; font-size:16px; font-weight:400; color:var(--text); }
  .list-type-tag {
    font-size:9px; letter-spacing:1.5px; text-transform:uppercase;
    padding:3px 8px; border-radius:100px; font-weight:600;
  }
  .tag-active { background:#eaf3ee; color:var(--now); }
  .tag-watching { background:var(--tag-bg); color:var(--muted); }

  .list-meta { font-size:11px; color:var(--muted); margin-bottom:12px; line-height:1.6; }
  .list-meta strong { color:var(--text-2); font-weight:500; }

  .list-shipments { display:flex; gap:4px; flex-wrap:wrap; margin-bottom:14px; }
  .shipment-pip {
    font-size:10px; font-weight:500; letter-spacing:0.3px;
    padding:3px 9px; border-radius:100px;
    border:1px solid var(--border);
    color:var(--muted);
    position:relative;
  }
  .shipment-pip.upcoming { background:var(--mid-bg); border-color:var(--mid); color:var(--mid); }
  .shipment-pip.open { background:#eaf3ee; border-color:var(--now); color:var(--now); font-weight:600; }
  .shipment-pip.open::before {
    content:''; display:inline-block; width:5px; height:5px;
    border-radius:50%; background:var(--now);
    margin-right:5px; vertical-align:middle; margin-bottom:1px;
    animation:pulse 1.5s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .list-actions { display:flex; gap:6px; }
  .btn-session {
    flex:1; height:32px;
    background:var(--accent); color:#fefcf9; border:none;
    border-radius:4px;
    font-family:'Outfit',sans-serif; font-size:11px; font-weight:500;
    letter-spacing:0.8px; text-transform:uppercase;
    cursor:pointer; transition:all 0.15s;
    display:flex; align-items:center; justify-content:center; gap:6px;
  }
  .btn-session:hover { background:var(--accent-mid); }
  .btn-session-ghost {
    flex:1; height:32px;
    background:none; color:var(--muted);
    border:1px solid var(--border);
    border-radius:4px;
    font-family:'Outfit',sans-serif; font-size:11px; font-weight:400;
    cursor:pointer; transition:all 0.15s;
  }
  .btn-session-ghost:hover { border-color:var(--accent); color:var(--accent); }

  /* Past sessions */
  .list-history { margin-top:10px; padding-top:10px; border-top:1px solid var(--border-soft); }
  .list-history-label { font-size:10px; letter-spacing:1.5px; text-transform:uppercase; color:var(--muted-2); font-weight:500; margin-bottom:6px; }
  .history-item { font-size:11px; color:var(--muted); display:flex; justify-content:space-between; padding:2px 0; }
  .history-item span:last-child { color:var(--text-2); font-weight:400; }

  /* ‚îÄ‚îÄ BUYING SESSION MODAL ‚îÄ‚îÄ */
  .session-modal-overlay {
    display:none; position:fixed; inset:0;
    background:rgba(28,24,20,0.5);
    backdrop-filter:blur(4px);
    z-index:1100;
    align-items:center; justify-content:center;
    padding:20px;
  }
  .session-modal-overlay.open { display:flex; animation:fadeIn 0.2s ease; }
  .session-modal {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:8px;
    width:100%; max-width:780px;
    max-height:92vh;
    overflow-y:auto;
    box-shadow:var(--shadow-lg);
    animation:slideUp 0.25s cubic-bezier(0.4,0,0.2,1);
    display:flex; flex-direction:column;
  }
  .session-header {
    padding:24px 30px 18px;
    border-bottom:1px solid var(--border-soft);
    display:flex; align-items:flex-start; justify-content:space-between;
    flex-shrink:0;
  }
  .session-header-left h3 { font-family:'Cormorant Garamond',serif; font-size:20px; font-weight:400; }
  .session-header-left p { font-size:12px; color:var(--muted); margin-top:3px; }
  .session-body { padding:24px 30px; flex:1; overflow-y:auto; }
  .session-footer {
    padding:16px 30px 24px;
    border-top:1px solid var(--border-soft);
    display:flex; gap:8px; justify-content:flex-end; align-items:center;
    flex-shrink:0;
  }

  /* Paste area */
  .paste-area {
    margin-bottom:20px;
  }
  .paste-label { font-size:10px; letter-spacing:2px; text-transform:uppercase; color:var(--muted); font-weight:500; margin-bottom:8px; display:block; }
  .paste-textarea {
    width:100%; min-height:120px; max-height:180px;
    border:1px solid var(--border); border-radius:10px;
    padding:14px 16px;
    font-family:'Outfit',sans-serif; font-size:13px; font-weight:300;
    color:var(--text); background:var(--surface-2);
    resize:vertical; outline:none; line-height:1.6;
    transition:border-color 0.15s;
  }
  .paste-textarea:focus { border-color:var(--accent); background:var(--surface); }
  .paste-textarea::placeholder { color:var(--muted-2); }
  .paste-hint { font-size:11px; color:var(--muted-2); margin-top:6px; }

  .btn-analyze {
    height:40px; padding:0 20px;
    background:var(--text); color:#fff; border:none;
    border-radius:9px;
    font-family:'Outfit',sans-serif; font-size:13px; font-weight:500;
    cursor:pointer; transition:all 0.15s;
    display:flex; align-items:center; gap:7px;
  }
  .btn-analyze:hover { background:var(--accent); }
  .btn-analyze:disabled { opacity:0.5; cursor:not-allowed; }

  /* Analysis results */
  .analysis-results { display:none; }
  .analysis-results.visible { display:block; animation:fadeIn 0.3s; }
  .analysis-summary {
    background:var(--surface-2); border:1px solid var(--border);
    border-radius:10px; padding:14px 18px; margin-bottom:16px;
    font-size:13px; color:var(--text-2); line-height:1.7;
  }
  .analysis-summary strong { color:var(--text); }

  .analysis-list { display:flex; flex-direction:column; gap:8px; margin-bottom:20px; }
  .analysis-row {
    background:var(--surface);
    border:1px solid var(--border);
    border-radius:10px;
    padding:14px 16px;
    display:grid;
    grid-template-columns:1fr auto auto;
    gap:12px;
    align-items:start;
  }
  .analysis-row.rec-buy { border-left:3px solid var(--now); }
  .analysis-row.rec-consider { border-left:3px solid #c9a020; }
  .analysis-row.rec-pass { border-left:3px solid var(--muted-2); opacity:0.7; }

  .analysis-wine-name { font-family:'Cormorant Garamond',serif; font-size:15px; font-weight:400; color:var(--text); margin-bottom:3px; }
  .analysis-price { font-size:11px; color:var(--muted); margin-bottom:6px; }
  .analysis-note { font-size:12px; color:var(--text-2); line-height:1.65; }
  .rec-badge {
    font-size:10px; letter-spacing:0.8px; text-transform:uppercase;
    font-weight:600; padding:3px 10px; border-radius:100px; white-space:nowrap;
    align-self:start;
  }
  .rec-badge.buy { background:#eaf3ee; color:var(--now); }
  .rec-badge.consider { background:#fef8e8; color:#9a7010; }
  .rec-badge.pass { background:var(--tag-bg); color:var(--muted); }

  .analysis-qty-wrap { display:flex; align-items:center; gap:6px; align-self:start; margin-top:1px; }
  .analysis-qty-btn {
    width:24px; height:24px; border-radius:6px;
    border:1px solid var(--border); background:none; cursor:pointer;
    display:flex; align-items:center; justify-content:center;
    color:var(--muted); font-size:13px; transition:all 0.15s;
  }
  .analysis-qty-btn:hover { border-color:var(--text); color:var(--text); }
  .analysis-qty-num { font-size:13px; font-weight:400; min-width:16px; text-align:center; }
  .analysis-qty-wrap.hidden { visibility:hidden; }

  .session-spend {
    font-size:12px; color:var(--muted); margin-right:auto;
  }
  .session-spend strong { color:var(--text); font-size:14px; font-family:'Cormorant Garamond',serif; }

  .analyzing-state {
    padding:32px 0; text-align:center;
    color:var(--muted); font-size:13px; display:none;
  }
  .analyzing-state.visible { display:block; }
  .analyzing-dots::after {
    content:''; animation:dots 1.4s infinite;
  }
  @keyframes dots {
    0%{content:''} 33%{content:'.'} 66%{content:'..'} 100%{content:'...'}
  }

  /* ‚îÄ‚îÄ RESPONSIVE: MOBILE ‚îÄ‚îÄ */
  @media(max-width:768px) {

    /* Viewport fix for iOS */
    body {
      padding-bottom: 80px; /* space for bottom tab bar */
      -webkit-text-size-adjust: 100%;
    }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    header {
      padding: 0 20px;
      height: 56px;
    }
    .header-left { gap: 16px; }
    .logo { font-size: 22px; letter-spacing: 3px; }
    .header-divider { display: none; }
    .header-stats { gap: 14px; }
    .hstat-num { font-size: 18px; }
    .hstat-label { font-size: 9px; letter-spacing: 0.8px; }
    .hstat-sep { font-size: 12px; }

    /* ‚îÄ‚îÄ ADD BOTTLE BAR ‚îÄ‚îÄ */
    div[style*="padding:10px 52px"] {
      padding: 10px 20px !important;
    }

    /* ‚îÄ‚îÄ TOP TAB BAR ‚Üí hide on mobile (replaced by bottom bar) ‚îÄ‚îÄ */
    .tab-bar { display: none; }

    /* ‚îÄ‚îÄ BOTTOM TAB BAR ‚îÄ‚îÄ */
    .mobile-tab-bar {
      display: flex !important;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      height: 72px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      z-index: 500;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .mobile-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px 4px;
      color: var(--muted);
      font-family: 'Outfit', sans-serif;
      font-size: 10px;
      font-weight: 400;
      letter-spacing: 0.8px;
      text-transform: uppercase;
      transition: color 0.15s;
      -webkit-tap-highlight-color: transparent;
      position: relative;
    }
    .mobile-tab.active { color: var(--accent); }
    .mobile-tab svg { width: 22px; height: 22px; }
    .mobile-tab-badge {
      position: absolute;
      top: 6px;
      right: calc(50% - 18px);
      background: var(--accent);
      color: #fff;
      font-size: 9px;
      font-weight: 600;
      min-width: 16px;
      height: 16px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
    .cellar-panel { padding: 0 16px 32px; }
    .map-panel { padding: 24px 16px 32px; }
    .wishlist-panel { padding: 0 16px 32px; }

    /* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
    .filters {
      padding: 14px 0 12px;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      gap: 6px;
      margin: 0 -16px;
      padding-left: 16px;
      padding-right: 16px;
    }
    .filters::-webkit-scrollbar { display: none; }
    .filter-label { display: none; }
    .filter-btn {
      flex-shrink: 0;
      white-space: nowrap;
      height: 34px;
      padding: 0 14px;
      font-size: 11px;
    }

    /* ‚îÄ‚îÄ SECTION HEADERS ‚îÄ‚îÄ */
    .section-header { margin-bottom: 14px; padding-bottom: 10px; }
    .section-title { font-size: 16px; }

    /* ‚îÄ‚îÄ WINE CARDS ‚îÄ‚îÄ */
    .wines-grid { grid-template-columns: 1fr; gap: 8px; }
    .wine-card { padding: 16px 16px; border-radius: 8px; }
    .wine-vintage { font-size: 26px; }
    .wine-name { font-size: 15px; }
    .card-qty-wrap { gap: 6px; }
    .card-qty-btn { width: 28px; height: 28px; font-size: 16px; }
    .card-qty-num { font-size: 14px; min-width: 22px; }
    .card-remove-btn { width: 28px; height: 28px; }

    /* ‚îÄ‚îÄ WISHLIST ‚îÄ‚îÄ */
    .wishlist-intro { flex-direction: column; gap: 10px; align-items: flex-start; padding: 16px 0 12px; }
    .wishlist-intro h2 { font-size: 18px; }
    .lists-grid { grid-template-columns: 1fr; }
    .lists-section { padding: 16px 0 8px; }
    .lists-header { margin-bottom: 12px; }

    .wish-row {
      grid-template-columns: auto 1fr;
      grid-template-rows: auto auto auto;
      gap: 6px 10px;
      padding: 14px 0;
    }
    .wish-vintage { grid-row: 1; grid-column: 1; font-size: 22px; line-height: 1; padding-top: 2px; }
    .wish-info { grid-row: 1; grid-column: 2; }
    .wish-name { font-size: 13px; }
    .wish-price { grid-row: 2; grid-column: 2; font-size: 12px; }
    .wish-qty { grid-row: 3; grid-column: 1 / -1; justify-self: start; }
    .wish-actions { grid-row: 3; grid-column: 1 / -1; justify-content: flex-start; gap: 6px; }
    .wish-btn { height: 34px; font-size: 11px; padding: 0 14px; }
    .qty-btn { width: 32px; height: 32px; font-size: 16px; }

    /* ‚îÄ‚îÄ MODALS ‚Üí bottom sheets ‚îÄ‚îÄ */
    .modal-overlay {
      align-items: flex-end !important;
      padding: 0 !important;
    }
    .modal {
      border-radius: 16px 16px 0 0 !important;
      max-height: 92vh !important;
      width: 100% !important;
      max-width: 100% !important;
      animation: slideUpSheet 0.3s cubic-bezier(0.4,0,0.2,1) !important;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .modal-header { padding: 20px 20px 16px; }
    .modal-body { padding: 0 20px 20px; }
    .modal-footer { padding: 16px 20px; }

    .session-modal-overlay {
      align-items: flex-end !important;
      padding: 0 !important;
    }
    .session-modal {
      border-radius: 16px 16px 0 0 !important;
      max-height: 94vh !important;
      width: 100% !important;
      max-width: 100% !important;
      animation: slideUpSheet 0.3s cubic-bezier(0.4,0,0.2,1) !important;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .session-header, .session-body, .session-footer {
      padding-left: 20px !important;
      padding-right: 20px !important;
    }

    /* Drag handle on bottom sheets */
    .modal::before, .session-modal::before {
      content: '';
      display: block;
      width: 36px; height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin: 12px auto 0;
    }

    /* ‚îÄ‚îÄ ANALYSIS ROWS ‚îÄ‚îÄ */
    .analysis-row { grid-template-columns: 1fr; gap: 8px; }
    .analysis-qty-wrap { justify-self: start; }

    /* ‚îÄ‚îÄ MAP ‚îÄ‚îÄ */
    .map-intro { margin-bottom: 18px; }
    .map-intro h2 { font-size: 17px; }
    .map-legend { gap: 12px; padding: 12px 16px; flex-wrap: wrap; }

    /* ‚îÄ‚îÄ SEARCH / FORM ‚îÄ‚îÄ */
    .search-row { flex-direction: column; gap: 8px; }
    .btn-search { width: 100%; justify-content: center; height: 40px; }
    .search-input { height: 40px; font-size: 16px; } /* 16px prevents iOS zoom */
    .form-grid { grid-template-columns: 1fr !important; }
    .form-group.full { grid-column: 1 !important; }
    input, textarea, select {
      font-size: 16px !important; /* prevents iOS zoom on focus */
    }

    /* ‚îÄ‚îÄ MISC ‚îÄ‚îÄ */
    .window-section { margin-bottom: 32px; }
    .wsummary-num { font-size: 20px; }
  }

  @keyframes slideUpSheet {
    from { transform: translateY(100%); opacity: 0.8; }
    to { transform: translateY(0); opacity: 1; }
  }
</style>
</head>
<body>

<header>
  <div class="header-left">
    <div class="logo"><em>Cuv√©e</em></div>
    <div class="header-divider"></div>
    <div class="header-stats">
      <div class="hstat">
        <span class="hstat-num" id="stat-bottles">17</span>
        <span class="hstat-label">bottles</span>
      </div>
      <span class="hstat-sep">¬∑</span>
      <div class="hstat">
        <span class="hstat-num" id="stat-producers">7</span>
        <span class="hstat-label">producers</span>
      </div>
      <span class="hstat-sep">¬∑</span>
      <div class="hstat">
        <span class="hstat-num" id="stat-regions">3</span>
        <span class="hstat-label">regions</span>
      </div>
    </div>
  </div>
</header>

<div style="background:var(--surface);border-bottom:1px solid var(--border);padding:10px 52px;display:flex;justify-content:flex-start;">
  <button class="btn-add" onclick="openModal()">
    <svg width="14" height="14" viewBox="0 0 14 14" fill="none"><path d="M7 1v12M1 7h12" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
    Add Bottle
  </button>
</div>

<div class="tab-bar">
  <button class="tab active" onclick="switchTab('cellar',this)">Collection</button>
  <button class="tab" onclick="switchTab('wishlist',this)">Allocations & Orders <span id="wish-tab-badge" style="display:none;background:var(--accent);color:#fff;font-size:10px;font-weight:600;padding:1px 6px;border-radius:100px;margin-left:5px;vertical-align:middle;"></span></button>
  <button class="tab" onclick="switchTab('map',this)">Origin Map</button>
</div>

<!-- MOBILE BOTTOM TAB BAR -->
<nav class="mobile-tab-bar" style="display:none;">
  <button class="mobile-tab active" id="mtab-cellar" onclick="switchTabMobile('cellar')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
    Collection
  </button>
  <button class="mobile-tab" id="mtab-wishlist" onclick="switchTabMobile('wishlist')" style="position:relative;">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="1"/><line x1="9" y1="12" x2="15" y2="12"/><line x1="9" y1="16" x2="13" y2="16"/></svg>
    Orders
    <span class="mobile-tab-badge" id="wish-mobile-badge" style="display:none;"></span>
  </button>
  <button class="mobile-tab" id="mtab-add" onclick="openModal()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
    Add
  </button>
  <button class="mobile-tab" id="mtab-map" onclick="switchTabMobile('map')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></svg>
    Map
  </button>
</nav>

<!-- COLLECTION TAB -->
<div class="tab-panel active" id="panel-cellar">
  <div class="cellar-panel">
    <div class="filters">
      <span class="filter-label">Filter</span>
      <button class="filter-btn active" onclick="filterWines('all',this)">All</button>
      <button class="filter-btn" onclick="filterWines('now',this)">Drink Now</button>
      <button class="filter-btn" onclick="filterWines('mid',this)">Mid-Term</button>
      <button class="filter-btn" onclick="filterWines('long',this)">Long-Term</button>
      <button class="filter-btn" onclick="filterWines('cab',this)">Cabernet</button>
      <button class="filter-btn" onclick="filterWines('pinot',this)">Pinot Noir</button>
      <button class="filter-btn" onclick="filterWines('chard',this)">Chardonnay</button>
      <button class="filter-btn" onclick="filterWines('blend',this)">Blends</button>
      <button class="filter-btn" onclick="filterWines('special',this)">‚óè Special</button>
    </div>
    <div class="window-section" id="section-now">
      <div class="section-header">
        <div class="section-pip pip-now"></div>
        <h2 class="section-title">Drink Now</h2>
        <span class="section-range">2025 ‚Äì 2027</span>
        <span class="section-count" id="count-now"></span>
      </div>
      <div class="wines-grid" id="grid-now"></div>
    </div>
    <div class="window-section" id="section-mid">
      <div class="section-header">
        <div class="section-pip pip-mid"></div>
        <h2 class="section-title">Mid-Term</h2>
        <span class="section-range">2027 ‚Äì 2030</span>
        <span class="section-count" id="count-mid"></span>
      </div>
      <div class="wines-grid" id="grid-mid"></div>
    </div>
    <div class="window-section" id="section-long">
      <div class="section-header">
        <div class="section-pip pip-long"></div>
        <h2 class="section-title">Long-Term Cellar</h2>
        <span class="section-range">2030 ‚Äì 2040+</span>
        <span class="section-count" id="count-long"></span>
      </div>
      <div class="wines-grid" id="grid-long"></div>
    </div>
  </div>
</div>

<!-- WISHLIST TAB -->
<div class="tab-panel" id="panel-wishlist">
  <div class="wishlist-panel">

    <!-- MAILING LISTS SECTION -->
    <div class="lists-section">
      <div class="lists-header">
        <div>
          <div class="lists-title">Mailing Lists & Clubs</div>
          <div class="lists-subtitle">Track allocations, open windows, and buying sessions</div>
        </div>
      </div>
      <div class="lists-grid" id="lists-grid"></div>
    </div>

    <!-- SHORTLIST SECTION -->
    <div class="wishlist-intro">
      <div class="wishlist-intro-left">
        <h2>Shortlist</h2>
        <p>Bottles you've decided to order ‚Äî not yet in the cellar</p>
      </div>
      <div class="wishlist-summary">
        <div class="wsummary-item">
          <span class="wsummary-num" id="wish-count">0</span>
          <span class="wsummary-label">Bottles</span>
        </div>
        <span class="wsummary-sep">¬∑</span>
        <div class="wsummary-item">
          <span class="wsummary-num" id="wish-total">$0</span>
          <span class="wsummary-label">Est. Total</span>
        </div>
      </div>
    </div>
    <div id="wishlist-content"></div>

  </div>
</div>

<!-- BUYING SESSION MODAL -->
<div class="session-modal-overlay" id="session-modal" onclick="handleSessionOverlayClick(event)">
  <div class="session-modal">
    <div class="session-header">
      <div class="session-header-left">
        <h3 id="session-title">Buying Session</h3>
        <p id="session-subtitle">Paste your allocation list and get recommendations</p>
      </div>
      <button class="modal-close" onclick="closeSessionModal()">‚úï</button>
    </div>
    <div class="session-body">
      <div class="paste-area" id="paste-area">
        <label class="paste-label">Paste your allocation list</label>
        <textarea class="paste-textarea" id="session-paste" placeholder="Paste the wines from your allocation email or offer list here ‚Äî wine names, prices, any notes. The more detail the better."></textarea>
        <div class="paste-hint">Tip: copy directly from the email or PDF. Include prices if available.</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:24px;">
        <button class="btn-analyze" id="btn-analyze" onclick="analyzeAllocation()">
          <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 1C3.46 1 1 3.46 1 6.5S3.46 12 6.5 12 12 9.54 12 6.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M9 1l1.5 1.5L9 4M10.5 2.5H7" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
          Analyze & Recommend
        </button>
        <span style="font-size:12px;color:var(--muted);" id="session-context-note"></span>
      </div>

      <div class="analyzing-state" id="analyzing-state">
        <div style="font-size:28px;margin-bottom:10px;">üç∑</div>
        <div>Analyzing your allocation<span class="analyzing-dots"></span></div>
        <div style="font-size:11px;color:var(--muted-2);margin-top:6px;">Considering your cellar and budget</div>
      </div>

      <div class="analysis-results" id="analysis-results">
        <div class="analysis-summary" id="analysis-summary"></div>
        <div class="analysis-list" id="analysis-list"></div>
      </div>
    </div>
    <div class="session-footer">
      <div class="session-spend" id="session-spend" style="display:none;">
        Selected: <strong id="session-spend-amt">$0</strong>
      </div>
      <button class="btn-cancel" onclick="closeSessionModal()">Close</button>
      <button class="btn-submit" id="btn-add-session" onclick="addSessionToShortlist()" style="display:none;">
        <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 1v11M1 6.5h11" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
        Add Selected to Shortlist
      </button>
    </div>
  </div>
</div>

<!-- MAP TAB -->
<div class="tab-panel" id="panel-map">
  <div class="map-panel">
    <div class="map-intro">
      <h2>Where it's from</h2>
      <p>Your collection spans three distinct California wine regions ‚Äî Napa Valley, Sonoma County, and Anderson Valley in Mendocino ‚Äî each with different climate, soils, and character.</p>
    </div>
    <div class="map-wrap">
      <svg viewBox="0 0 860 520" xmlns="http://www.w3.org/2000/svg" class="cellar-map">
        <defs>
          <filter id="dropshadow"><feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(0,0,0,0.12)"/></filter>
          <linearGradient id="oceanGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#b8cfd8"/>
            <stop offset="100%" stop-color="#cddee5"/>
          </linearGradient>
          <linearGradient id="landGrad" x1="0%" y1="0%" x2="10%" y2="100%">
            <stop offset="0%" stop-color="#e2ddd2"/>
            <stop offset="100%" stop-color="#d5d0c4"/>
          </linearGradient>
          <linearGradient id="hillGrad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="#c8c2b4"/>
            <stop offset="100%" stop-color="#d5d0c4"/>
          </linearGradient>
          <radialGradient id="napaFill" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#c97a3a" stop-opacity="0.2"/>
            <stop offset="100%" stop-color="#c97a3a" stop-opacity="0.03"/>
          </radialGradient>
          <radialGradient id="sonomaFill" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#7a5a8a" stop-opacity="0.18"/>
            <stop offset="100%" stop-color="#7a5a8a" stop-opacity="0.03"/>
          </radialGradient>
          <radialGradient id="andersonFill" cx="50%" cy="50%" r="50%">
            <stop offset="0%" stop-color="#3a7a8a" stop-opacity="0.2"/>
            <stop offset="100%" stop-color="#3a7a8a" stop-opacity="0.03"/>
          </radialGradient>
          <pattern id="topo" patternUnits="userSpaceOnUse" width="80" height="80">
            <ellipse cx="40" cy="40" rx="32" ry="18" fill="none" stroke="rgba(90,80,60,0.055)" stroke-width="1"/>
            <ellipse cx="40" cy="40" rx="20" ry="10" fill="none" stroke="rgba(90,80,60,0.055)" stroke-width="1"/>
          </pattern>
        </defs>
        <rect x="0" y="0" width="220" height="520" fill="url(#oceanGrad)"/>
        <path d="M15,70 Q55,62 95,70 Q135,78 175,70 Q205,64 220,67" fill="none" stroke="rgba(255,255,255,0.55)" stroke-width="1.2"/>
        <path d="M5,130 Q50,122 95,130 Q140,138 185,130 Q210,125 220,127" fill="none" stroke="rgba(255,255,255,0.5)" stroke-width="1.2"/>
        <path d="M0,195 Q45,187 90,195 Q135,203 180,195 Q205,190 220,192" fill="none" stroke="rgba(255,255,255,0.45)" stroke-width="1.2"/>
        <path d="M0,260 Q45,252 90,260 Q135,268 180,260 Q205,255 220,257" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="1.2"/>
        <path d="M0,325 Q50,317 100,325 Q150,333 200,325 Q215,322 220,323" fill="none" stroke="rgba(255,255,255,0.38)" stroke-width="1.2"/>
        <path d="M0,390 Q50,382 100,390 Q150,398 200,390 Q215,387 220,388" fill="none" stroke="rgba(255,255,255,0.35)" stroke-width="1.2"/>
        <path d="M0,455 Q50,447 100,455 Q150,463 200,455" fill="none" stroke="rgba(255,255,255,0.32)" stroke-width="1.2"/>
        <text x="38" y="500" fill="rgba(70,110,135,0.45)" font-size="9" font-family="'Outfit',sans-serif" letter-spacing="2.5" text-anchor="middle" transform="rotate(-90,38,500)">PACIFIC OCEAN</text>
        <path d="M 220,0 L 860,0 L 860,520 L 220,520 L 218,500 L 214,478 L 210,455 L 208,432 L 212,408 L 215,384 L 212,360 L 207,336 L 203,312 L 204,288 L 208,264 L 212,240 L 216,216 L 218,192 L 214,168 L 208,144 L 210,120 L 214,96 L 212,72 L 215,48 L 218,24 L 220,0 Z" fill="url(#landGrad)"/>
        <path d="M 220,0 L 860,0 L 860,520 L 220,520 L 218,500 L 214,478 L 210,455 L 208,432 L 212,408 L 215,384 L 212,360 L 207,336 L 203,312 L 204,288 L 208,264 L 212,240 L 216,216 L 218,192 L 214,168 L 208,144 L 210,120 L 214,96 L 212,72 L 215,48 L 218,24 L 220,0 Z" fill="url(#topo)"/>
        <path d="M220,0 L300,0 L308,40 L304,80 L296,120 L290,160 L286,200 L285,240 L288,280 L292,320 L294,360 L290,400 L285,440 L282,480 L280,520 L220,520 Z" fill="url(#hillGrad)" opacity="0.5"/>
        <path d="M430,60 C425,105 422,150 425,196 C428,242 432,288 430,334 C428,375 424,415 427,455" stroke="rgba(120,108,85,0.45)" stroke-width="7" fill="none" stroke-linecap="round"/>
        <path d="M430,60 C425,105 422,150 425,196 C428,242 432,288 430,334 C428,375 424,415 427,455" stroke="rgba(150,138,112,0.18)" stroke-width="16" fill="none" stroke-linecap="round"/>
        <text x="410" y="270" fill="rgba(110,98,75,0.5)" font-size="8" font-family="'Outfit',sans-serif" letter-spacing="1" text-anchor="middle" transform="rotate(-90,410,270)">MAYACAMAS MTS.</text>
        <path d="M668,110 C664,158 660,205 663,252 C666,298 670,344 668,390" stroke="rgba(120,108,85,0.3)" stroke-width="5" fill="none" stroke-linecap="round"/>
        <text x="686" y="265" fill="rgba(110,98,75,0.38)" font-size="7.5" font-family="'Outfit',sans-serif" letter-spacing="1" text-anchor="middle" transform="rotate(-90,686,265)">VACA MTS.</text>
        <path d="M295,55 C300,85 304,115 298,148 C292,180 284,205 288,235 C292,265 302,282 298,312 C294,338 284,355 290,378 C296,400 312,415 322,438 C332,460 330,485 338,505" stroke="rgba(90,140,175,0.45)" stroke-width="2" fill="none"/>
        <path d="M545,165 C542,200 538,240 540,280 C542,318 548,355 545,390 C542,420 538,448 542,478" stroke="rgba(90,140,175,0.35)" stroke-width="1.5" fill="none"/>
        <path d="M506,450 C518,438 542,432 558,440 C574,448 580,465 572,478 C564,492 542,496 525,488 C507,479 494,462 506,450 Z" fill="url(#oceanGrad)" opacity="0.75"/>
        <text x="538" y="468" fill="rgba(70,110,135,0.45)" font-size="8" font-family="'Outfit',sans-serif" text-anchor="middle">SF Bay</text>
        <ellipse cx="318" cy="108" rx="65" ry="78" fill="url(#andersonFill)" stroke="#3a7a8a" stroke-width="1.5" stroke-dasharray="6,4"/>
        <text x="318" y="94" fill="#2a6a7a" font-size="8.5" font-family="'Outfit',sans-serif" font-weight="500" letter-spacing="1.5" text-anchor="middle">ANDERSON</text>
        <text x="318" y="107" fill="#2a6a7a" font-size="8.5" font-family="'Outfit',sans-serif" font-weight="500" letter-spacing="1.5" text-anchor="middle">VALLEY</text>
        <text x="318" y="120" fill="rgba(42,106,122,0.5)" font-size="7" font-family="'Outfit',sans-serif" letter-spacing="1" text-anchor="middle">Mendocino Co.</text>
        <ellipse cx="348" cy="308" rx="88" ry="112" fill="url(#sonomaFill)" stroke="#7a5a8a" stroke-width="1.5" stroke-dasharray="6,4"/>
        <text x="348" y="292" fill="#5a3a6a" font-size="8.5" font-family="'Outfit',sans-serif" font-weight="500" letter-spacing="1.5" text-anchor="middle">SONOMA</text>
        <text x="348" y="305" fill="#5a3a6a" font-size="8.5" font-family="'Outfit',sans-serif" font-weight="500" letter-spacing="1.5" text-anchor="middle">COUNTY</text>
        <ellipse cx="548" cy="288" rx="52" ry="148" fill="url(#napaFill)" stroke="#c97a3a" stroke-width="1.5" stroke-dasharray="6,4" transform="rotate(-5,548,288)"/>
        <text x="552" y="256" fill="#8b4513" font-size="8.5" font-family="'Outfit',sans-serif" font-weight="500" letter-spacing="1.5" text-anchor="middle">NAPA</text>
        <text x="552" y="269" fill="#8b4513" font-size="8.5" font-family="'Outfit',sans-serif" font-weight="500" letter-spacing="1.5" text-anchor="middle">VALLEY</text>
        <g id="pin-williams-selyem" transform="translate(318,158)" filter="url(#dropshadow)" style="transition:opacity 0.5s"><circle r="15" fill="rgba(58,122,138,0.12)" stroke="rgba(58,122,138,0.35)" stroke-width="1.2"/><circle r="6" fill="#3a7a8a"/><circle r="2.5" fill="white" opacity="0.85"/></g>
        <line x1="318" y1="173" x2="318" y2="195" stroke="#3a7a8a" stroke-width="1" opacity="0.5" stroke-dasharray="3,2"/>
        <g id="label-williams-selyem" style="transition:opacity 0.5s"><rect x="252" y="196" width="132" height="32" rx="6" fill="white" stroke="rgba(58,122,138,0.25)" stroke-width="1" filter="url(#dropshadow)"/>
        <text x="318" y="210" fill="#1a1814" font-size="9.5" font-family="'Outfit',sans-serif" font-weight="500" text-anchor="middle">Williams Selyem</text>
        <text x="318" y="222" fill="#8c8680" font-size="8" font-family="'Outfit',sans-serif" text-anchor="middle">Ferrington Vineyard</text></g>
        <g id="pin-enroute" transform="translate(330,362)" filter="url(#dropshadow)" style="transition:opacity 0.5s"><circle r="14" fill="rgba(122,90,138,0.12)" stroke="rgba(122,90,138,0.35)" stroke-width="1.2"/><circle r="5.5" fill="#7a5a8a"/><circle r="2.2" fill="white" opacity="0.85"/></g>
        <line x1="330" y1="376" x2="240" y2="400" stroke="#7a5a8a" stroke-width="1" opacity="0.45" stroke-dasharray="3,2"/>
        <g id="label-enroute" style="transition:opacity 0.5s"><rect x="168" y="400" width="148" height="32" rx="6" fill="white" stroke="rgba(122,90,138,0.22)" stroke-width="1" filter="url(#dropshadow)"/>
        <text x="242" y="414" fill="#1a1814" font-size="9.5" font-family="'Outfit',sans-serif" font-weight="500" text-anchor="middle">EnRoute</text>
        <text x="242" y="426" fill="#8c8680" font-size="8" font-family="'Outfit',sans-serif" text-anchor="middle">Amber Ridge ¬∑ Northern Spy</text></g>
        <g id="pin-lasseter" transform="translate(395,328)" filter="url(#dropshadow)" style="transition:opacity 0.5s"><circle r="12" fill="rgba(122,90,138,0.1)" stroke="rgba(122,90,138,0.3)" stroke-width="1.2"/><circle r="5" fill="#9a7aaa"/><circle r="2" fill="white" opacity="0.85"/></g>
        <line x1="395" y1="340" x2="395" y2="370" stroke="#7a5a8a" stroke-width="1" opacity="0.4" stroke-dasharray="3,2"/>
        <g id="label-lasseter" style="transition:opacity 0.5s"><rect x="328" y="370" width="136" height="32" rx="6" fill="white" stroke="rgba(122,90,138,0.2)" stroke-width="1" filter="url(#dropshadow)"/>
        <text x="396" y="384" fill="#1a1814" font-size="9.5" font-family="'Outfit',sans-serif" font-weight="500" text-anchor="middle">Lasseter Family</text>
        <text x="396" y="396" fill="#8c8680" font-size="8" font-family="'Outfit',sans-serif" text-anchor="middle">Moon Mountain Estate</text></g>
        <g id="pin-far-niente" transform="translate(540,308)" filter="url(#dropshadow)" style="transition:opacity 0.5s"><circle r="17" fill="rgba(201,122,58,0.14)" stroke="rgba(201,122,58,0.4)" stroke-width="1.5"/><circle r="7" fill="#c97a3a"/><circle r="3" fill="white" opacity="0.88"/></g>
        <line x1="540" y1="325" x2="628" y2="358" stroke="#c97a3a" stroke-width="1" opacity="0.45" stroke-dasharray="3,2"/>
        <g id="label-far-niente" style="transition:opacity 0.5s"><rect x="580" y="358" width="136" height="32" rx="6" fill="white" stroke="rgba(201,122,58,0.28)" stroke-width="1" filter="url(#dropshadow)"/>
        <text x="648" y="372" fill="#1a1814" font-size="9.5" font-family="'Outfit',sans-serif" font-weight="500" text-anchor="middle">Far Niente</text>
        <text x="648" y="384" fill="#8c8680" font-size="8" font-family="'Outfit',sans-serif" text-anchor="middle">Oakville ¬∑ Cave Collection</text></g>
        <g id="pin-opus-one" transform="translate(556,278)" filter="url(#dropshadow)" style="transition:opacity 0.5s"><circle r="12" fill="rgba(201,122,58,0.1)" stroke="rgba(201,122,58,0.3)" stroke-width="1"/><circle r="5" fill="#d49050"/><circle r="2" fill="white" opacity="0.85"/></g>
        <line x1="556" y1="266" x2="640" y2="240" stroke="#c97a3a" stroke-width="1" opacity="0.38" stroke-dasharray="3,2"/>
        <g id="label-opus-one" style="transition:opacity 0.5s"><rect x="590" y="224" width="108" height="30" rx="6" fill="white" stroke="rgba(201,122,58,0.2)" stroke-width="1" filter="url(#dropshadow)"/>
        <text x="644" y="237" fill="#1a1814" font-size="9.5" font-family="'Outfit',sans-serif" font-weight="500" text-anchor="middle">Opus One</text>
        <text x="644" y="248" fill="#8c8680" font-size="8" font-family="'Outfit',sans-serif" text-anchor="middle">Overture ¬∑ Oakville</text></g>
        <g id="pin-nickel" transform="translate(534,336)" filter="url(#dropshadow)" style="transition:opacity 0.5s"><circle r="14" fill="rgba(201,122,58,0.1)" stroke="rgba(201,122,58,0.32)" stroke-width="1.2"/><circle r="6" fill="#c97a3a"/><circle r="2.5" fill="white" opacity="0.85"/></g>
        <line x1="534" y1="350" x2="620" y2="400" stroke="#c97a3a" stroke-width="1" opacity="0.4" stroke-dasharray="3,2"/>
        <g id="label-nickel" style="transition:opacity 0.5s"><rect x="568" y="400" width="162" height="44" rx="6" fill="white" stroke="rgba(201,122,58,0.22)" stroke-width="1" filter="url(#dropshadow)"/>
        <text x="649" y="413" fill="#1a1814" font-size="9.5" font-family="'Outfit',sans-serif" font-weight="500" text-anchor="middle">Nickel &amp; Nickel</text>
        <text x="649" y="424" fill="#8c8680" font-size="7.5" font-family="'Outfit',sans-serif" text-anchor="middle">CC Ranch ¬∑ Quicksilver ¬∑ Morisoli</text>
        <text x="649" y="436" fill="#8c8680" font-size="7.5" font-family="'Outfit',sans-serif" text-anchor="middle">State Ranch ¬∑ Fog Break ¬∑ Element 28</text></g>
        <g id="pin-bella-union" transform="translate(522,292)" filter="url(#dropshadow)" style="transition:opacity 0.5s"><circle r="9" fill="rgba(201,122,58,0.08)" stroke="rgba(201,122,58,0.22)" stroke-width="1"/><circle r="4" fill="#d4956a"/><circle r="1.8" fill="white" opacity="0.8"/></g>
        <line x1="522" y1="283" x2="460" y2="258" stroke="#c97a3a" stroke-width="1" opacity="0.32" stroke-dasharray="3,2"/>
        <g id="label-bella-union" style="transition:opacity 0.5s"><rect x="380" y="243" width="104" height="28" rx="6" fill="white" stroke="rgba(201,122,58,0.16)" stroke-width="1" filter="url(#dropshadow)"/>
        <text x="432" y="255" fill="#1a1814" font-size="9" font-family="'Outfit',sans-serif" font-weight="500" text-anchor="middle">Bella Union</text>
        <text x="432" y="265" fill="#8c8680" font-size="8" font-family="'Outfit',sans-serif" text-anchor="middle">La Gemma ¬∑ Napa</text></g>
        <circle cx="498" cy="480" r="3" fill="rgba(100,90,80,0.35)"/>
        <text x="498" y="495" fill="rgba(100,90,80,0.5)" font-size="8" font-family="'Outfit',sans-serif" text-anchor="middle">Napa</text>
        <circle cx="344" cy="450" r="3" fill="rgba(100,90,80,0.35)"/>
        <text x="344" y="464" fill="rgba(100,90,80,0.5)" font-size="8" font-family="'Outfit',sans-serif" text-anchor="middle">Santa Rosa</text>
        <circle cx="264" cy="205" r="3" fill="rgba(100,90,80,0.35)"/>
        <text x="264" y="198" fill="rgba(100,90,80,0.5)" font-size="8" font-family="'Outfit',sans-serif" text-anchor="middle">Ukiah</text>
        <text x="730" y="480" fill="rgba(100,90,78,0.3)" font-size="11" font-family="'Outfit',sans-serif" letter-spacing="2" text-anchor="middle">CALIFORNIA</text>
        <g transform="translate(812,46)">
          <circle r="20" fill="white" stroke="rgba(200,195,188,0.9)" stroke-width="1" filter="url(#dropshadow)"/>
          <line x1="0" y1="-13" x2="0" y2="13" stroke="#bbb" stroke-width="1"/>
          <line x1="-13" y1="0" x2="13" y2="0" stroke="#bbb" stroke-width="1"/>
          <polygon points="0,-15 2.5,-6 0,-9 -2.5,-6" fill="#444"/>
          <text x="0" y="-18" fill="#555" font-size="8.5" font-family="'Outfit',sans-serif" text-anchor="middle" font-weight="500">N</text>
        </g>
        <g transform="translate(692,482)">
          <line x1="0" y1="0" x2="76" y2="0" stroke="rgba(100,90,78,0.4)" stroke-width="1.5"/>
          <line x1="0" y1="-4" x2="0" y2="4" stroke="rgba(100,90,78,0.4)" stroke-width="1.5"/>
          <line x1="76" y1="-4" x2="76" y2="4" stroke="rgba(100,90,78,0.4)" stroke-width="1.5"/>
          <text x="38" y="-7" fill="rgba(100,90,78,0.5)" font-size="7.5" font-family="'Outfit',sans-serif" letter-spacing="0.5" text-anchor="middle">~30 miles</text>
        </g>
      </svg>
      <div class="map-legend">
        <div class="legend-item"><div class="legend-dot" style="background:#3a7a8a;"></div>Anderson Valley</div>
        <div class="legend-item"><div class="legend-dot" style="background:#7a5a8a;"></div>Sonoma County</div>
        <div class="legend-item"><div class="legend-dot" style="background:#c97a3a;"></div>Napa Valley</div>
        <div class="legend-item" style="margin-left:auto;"><div style="width:18px;height:2px;background:rgba(120,108,85,0.5);border-radius:2px;margin-right:6px;"></div>Mountain ridge</div>
      </div>
    </div>
  </div>
</div>

<!-- ADD BOTTLE MODAL -->
<div class="modal-overlay" id="modal" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-header">
      <div>
        <div class="modal-title">Add a Bottle</div>
        <div class="modal-subtitle">Search for a wine or fill in the details manually</div>
      </div>
      <button class="modal-close" onclick="closeModal()">‚úï</button>
    </div>
    <div class="modal-body">
      <!-- Search -->
      <div class="search-section">
        <label class="search-label">Search wine</label>
        <div class="search-row">
          <input class="search-input" id="wine-search" placeholder="e.g. Opus One 2019, Far Niente Chardonnay‚Ä¶" onkeydown="if(event.key==='Enter')searchWine()"/>
          <button class="btn-search" id="btn-search" onclick="searchWine()">
            <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><circle cx="5.5" cy="5.5" r="4" stroke="currentColor" stroke-width="1.5"/><path d="M9 9l2.5 2.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            Search
          </button>
        </div>
        <div class="search-status" id="search-status"></div>
      </div>

      <!-- Wine Preview Card -->
      <div class="wine-preview" id="wine-preview">
        <div class="preview-header">
          <div class="preview-meta">
            <div class="preview-producer" id="prev-producer"></div>
            <div class="preview-name" id="prev-name"></div>
            <div class="preview-region" id="prev-region"></div>
          </div>
          <div style="display:flex;align-items:flex-start;gap:8px;">
            <span class="preview-badge" id="prev-badge"></span>
          </div>
          <div class="preview-vintage" id="prev-vintage-bg"></div>
        </div>
        <div class="preview-body">
          <div class="preview-section" id="prev-notes-section">
            <div class="detail-label">Tasting Notes <span class="ai-tag">AI</span></div>
            <div class="preview-notes" id="prev-notes"></div>
          </div>
          <div class="preview-section" id="prev-ratings-section">
            <div class="detail-label">Scores</div>
            <div class="preview-ratings" id="prev-ratings"></div>
          </div>
          <div class="preview-section">
            <div class="detail-label">Drink Window</div>
            <div class="preview-drink" id="prev-drink"></div>
          </div>
        </div>
      </div>

      <!-- Manual Form -->
      <div class="form-section" id="form-section" style="display:none;">
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label">Producer *</label>
            <input class="form-input" id="f-producer" placeholder="e.g. Far Niente" />
          </div>
          <div class="form-group">
            <label class="form-label">Vintage *</label>
            <input class="form-input" id="f-vintage" type="number" placeholder="e.g. 2021" min="1900" max="2030"/>
          </div>
          <div class="form-group full">
            <label class="form-label">Wine Name *</label>
            <input class="form-input" id="f-name" placeholder="e.g. Cabernet Sauvignon, Cave Collection" />
          </div>
          <div class="form-group">
            <label class="form-label">Region</label>
            <input class="form-input" id="f-region" placeholder="e.g. Oakville, Napa Valley" />
          </div>
          <div class="form-group">
            <label class="form-label">Varietal</label>
            <select class="form-select" id="f-type">
              <option value="cab">Cabernet Sauvignon</option>
              <option value="pinot">Pinot Noir</option>
              <option value="chard">Chardonnay</option>
              <option value="blend">Blend</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Drink Window</label>
            <input class="form-input" id="f-drink" placeholder="e.g. 2026 ‚Äì 2032" />
          </div>
          <div class="form-group">
            <label class="form-label">Quantity</label>
            <input class="form-input" id="f-qty" type="number" placeholder="1" min="1" max="99" value="1"/>
          </div>
          <div class="form-group">
            <label class="form-label">Aging Horizon</label>
            <select class="form-select" id="f-window">
              <option value="now">Drink Now</option>
              <option value="mid">Mid-Term</option>
              <option value="long">Long-Term</option>
            </select>
          </div>
          <div class="form-group full">
            <label class="form-label">Tasting Notes</label>
            <textarea class="form-textarea" id="f-notes" placeholder="Describe the wine's aromas, palate, and finish‚Ä¶"></textarea>
          </div>
          <div class="form-group full">
            <label class="form-label">Background / Producer Story</label>
            <textarea class="form-textarea" id="f-background" placeholder="Winery history, vineyard details, vintage notes‚Ä¶"></textarea>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;margin-top:4px;">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:13px;color:var(--text-2);">
            <input type="checkbox" id="f-special" style="accent-color:var(--accent);width:14px;height:14px;"/>
            Mark as special / flagship bottle
          </label>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-submit" id="btn-submit" onclick="addBottle()" disabled>
        <svg width="13" height="13" viewBox="0 0 13 13" fill="none"><path d="M6.5 1v11M1 6.5h11" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"/></svg>
        Add to Cellar
      </button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ‚îÄ DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let wines = [
  {vintage:2023,producer:"Littorai",name:"B.A. Thieriot Vineyard Chardonnay",region:"Sonoma Coast",window:"mid",type:"chard",badge:"Chardonnay",background:"Perched on a ridge 350 meters above Occidental, B.A. Thieriot is a cool, high-elevation site farmed organically and biodynamically with no irrigation ‚Äî very low yields, intensely concentrated fruit. Ted Lemon founded Littorai in 1993 after training at Domaine Guy Roulot in Meursault; his Chardonnays are benchmarks for precision and terroir expression in California. Available only direct from the winery and on the mailing list.",notes:"Understated and elegant with subtle aromas of pear blossom, lychee, and yellow rose. More linear and acid-driven than other vintages ‚Äî savory, saline, and umami on the palate with a mouthwatering, long finish. Bracing energy and purity. A wine that rewards patience.",ratings:[{score:"96",source:"Wine Advocate"}],drink:"2025 ‚Äì 2033",qty:1},
  {vintage:2022,producer:"Far Niente",name:"Cave Collection Chardonnay",region:"Napa Valley",window:"now",type:"chard",badge:"Chardonnay",background:"The Cave Collection is Far Niente's library tier ‚Äî wines held back and aged in their historic caves before release. Only available through the Cave Club membership, not on the open market. Far Niente, founded in 1885 and restored in 1979, has produced Chardonnay from Coombsville and Oakville estate vineyards since 1982. This 2022 vintage draws from Coombsville ‚Äî a cool, fog-influenced sub-AVA east of Napa city with volcanic ash and gravelly loam soils.",notes:"Enchanting aromatics of citrus, white floral, honeydew melon, and nectarine, with sweet vanilla cream and elderflower. Exquisitely graceful mouthfeel ‚Äî silky entry that builds to a long finish with luscious ripe pineapple and lingering citrus. Crisp minerality and juicy acidity provide excellent structure for graceful aging.",ratings:[{score:"94",source:"Wine Enthusiast"},{score:"92",source:"Wine Spectator"}],drink:"Now ‚Äì 2027",special:true},
  {vintage:2024,producer:"Far Niente",name:"Chardonnay",region:"Napa Valley",window:"now",type:"chard",badge:"Chardonnay",background:"Far Niente's flagship white has been a benchmark Napa Chardonnay since 1982. Sourced from estate vineyards in Coombsville ‚Äî a protected, fog-cooled sub-AVA with volcanic ash soils that preserve acidity. 100% barrel fermented and aged in French oak. One of only two wines Far Niente produces, reflecting their focused approach to quality over quantity.",notes:"Richly aromatic with bright citrus, melon, and pear on the nose. Creamy, lush texture carrying tropical fruits, butter, toast, baked apples, vanilla, Bartlett pears, and almonds. Bold and full-bodied with a crisp thread of acidity that keeps the flavors energetic and fresh through a long, lingering finish.",ratings:[{score:"94",source:"Wine Enthusiast"},{score:"92",source:"Wine Spectator"}],drink:"Now ‚Äì 2028"},
  {vintage:2020,producer:"Lasseter Family",name:"Paysage",region:"Sonoma Valley",window:"now",type:"blend",badge:"Blend",background:"Named 'Paysage' ‚Äî French for landscape painting ‚Äî this is Lasseter's approachable, food-friendly red blend. Founded by John and Nancy Lasseter (John is the former Pixar and Disney creative chief), the winery is organically farmed on their estate in Glen Ellen, Sonoma Valley. Paysage is their entry into Bordeaux-style blending, designed to be enjoyed younger than their prestige Cabernet.",notes:"Merlot-led with Cabernet Sauvignon and Malbec. Soft and approachable with pure berry flavors ‚Äî plum, red cherry, and blueberry ‚Äî with a rich, supple mouthfeel and balanced acidity. Seamless and food-friendly, with a clean, mellow finish.",ratings:[],drink:"Now ‚Äì 2026"},
  {vintage:2021,producer:"Opus One",name:"Overture",region:"Oakville, Napa Valley",window:"now",type:"blend",badge:"Blend",background:"Historic milestone: the first-ever vintage-dated release of Overture, Opus One's second wine (previously released as non-vintage since 1993). Opus One was founded in 1979 as a joint venture between Robert Mondavi and Baron Philippe de Rothschild of Ch√¢teau Mouton Rothschild. The 2021 vintage was the second driest in Opus One's history, yielding lower-than-average but exceptionally concentrated fruit. Blend: 89% Cabernet Sauvignon, 4% Cabernet Franc, 4% Petit Verdot, 3% Merlot. Aged in 65% new French oak.",notes:"Fresh aromas of plum, blackberry, and cherry with dried rose petal, forest floor, and earthy minerality. Juicy and bright on the palate with black currant, blueberry, and wild strawberry. Velvety texture with powdery, chalky tannins. Subtle coffee and dark chocolate on the long finish.",ratings:[{score:"95",source:"Wine Advocate"},{score:"94",source:"Wine Spectator"},{score:"93",source:"Jane Anson"}],drink:"Now ‚Äì 2036",special:true},
  {vintage:2022,producer:"Bella Union",name:"La Gemma",region:"Napa Valley",window:"now",type:"blend",badge:"Blend",background:"Bella Union is Far Niente's Napa red-wine label. La Gemma ‚Äî Italian for 'the gem' ‚Äî is their prestige Bordeaux-style blend representing the best of their Napa fruit in a given vintage. The winery recently opened a dedicated facility in Rutherford.",notes:"A Bordeaux-style blend of Cabernet Sauvignon, Malbec, Merlot, Petit Verdot, and Cabernet Franc. Rich and layered with blackcurrants, plums, tobacco, graphite, and earthy minerality. Velvety tannins and a long, complex finish ‚Äî more ambitious than their standard Cabernet.",ratings:[],drink:"Now ‚Äì 2028"},
  {vintage:2023,producer:"EnRoute",name:"Amber Ridge Vineyard Pinot Noir",region:"Russian River Valley",window:"mid",type:"pinot",badge:"Pinot Noir",background:"EnRoute is Far Niente's Sonoma Pinot Noir label. Amber Ridge is their estate vineyard in the warmer middle reach of the Russian River Valley on the Santa Rosa Plain. Planted with Pommard, Calera, and multiple Dijon clones using vertical trellising to concentrate fruit.",notes:"More body and darker fruit than the Northern Spy ‚Äî structured and spice-driven with black cherry, dried plum, and a savory, earthy undercurrent. Wood spices and anise add complexity on the mid-palate, with polished tannins and a warm, spice-laced finish.",ratings:[{score:"94",source:"Wine Enthusiast (prior vintage)"}],drink:"2026 ‚Äì 2031"},
  {vintage:2023,producer:"Nickel & Nickel",name:"Quicksilver Vineyard Cabernet Sauvignon",region:"Rutherford, Napa Valley",window:"mid",type:"cab",badge:"Cabernet",background:"Nickel & Nickel was founded in 1997 with a singular focus: single-vineyard, single-varietal Cabernet Sauvignon from Napa's most distinctive sites. Quicksilver sits in the heart of Rutherford ‚Äî known for its 'Rutherford Dust' quality in the tannins, warm days, cool nights, and well-drained benchland soils.",notes:"Juicy berries and ripe plums lifted by mountain thyme, lavender, and violets on the nose. Fully expressive on the palate with black currant, graphite, and cocoa layered over fine-grained tannins. Classic Rutherford depth and elegance.",ratings:[{score:"94",source:"Wine Enthusiast (2022)"},{score:"96",source:"James Suckling (2023)"}],drink:"2026 ‚Äì 2031"},
  {vintage:2023,producer:"Nickel & Nickel",name:"State Ranch Cabernet Sauvignon",region:"Yountville, Napa Valley",window:"mid",type:"cab",badge:"Cabernet",background:"State Ranch sits in Yountville ‚Äî Napa's southernmost and coolest major Cab sub-AVA. The cooler climate produces Cab with gentler tannins and more immediate drinkability, while still offering good depth and structure for mid-term aging.",notes:"Full-bodied yet silken with rich chocolate, cassis, fruit liqueurs, coffee, and spices. Generous and enveloping with a mouthcoating texture. Best enjoyed with rich and savory foods or with a few more years of bottle age.",ratings:[{score:"93",source:"Wine Enthusiast (2022)"}],drink:"2025 ‚Äì 2030"},
  {vintage:2023,producer:"Nickel & Nickel",name:"Fog Break Vineyard Cabernet Sauvignon",region:"Atlas Peak, Napa Valley",window:"mid",type:"cab",badge:"Cabernet",background:"Fog Break sits high in the Atlas Peak AVA on Napa's eastern hillsides ‚Äî thin volcanic soils, sun-drenched exposure, dramatic elevation. The vineyard takes its name from the fog line that forms in the valley below each morning. High-altitude growing extends hang time and creates the signature iron and graphite minerality not found in valley-floor Cabs.",notes:"Opens with violets, dark espresso, and eucalyptus. Concentrated black cherries, boysenberry, and mission figs with sage, graphite, and volcanic minerals. Big and firmly structured ‚Äî Valrhona cocoa powder, tobacco, and basalt on the finish.",ratings:[{score:"97",source:"James Suckling (2021)"},{score:"94",source:"Wine Enthusiast (2021)"}],drink:"2027 ‚Äì 2033"},
  {vintage:2022,producer:"Williams Selyem",name:"Ferrington Vineyard Pinot Noir",region:"Anderson Valley",window:"mid",type:"pinot",badge:"Pinot Noir",background:"Williams Selyem has sourced from Kurt Schoeneman's Ferrington Vineyard in Boonville, Mendocino County, since 1997. Ferrington sits in the warmer 'deep end' of Anderson Valley, where large diurnal swings and a long growing season create wines of electric acidity and spice. The 2022 vintage was one of the driest first halves on record, concentrating flavors while preserving freshness.",notes:"Red currant and cranberry on an explosive nose with black cherry, anise, and clove. Bergamot, currant, and cranberry on the palate with refreshing tangerine tanginess. Electric, high-acid, spice-driven ‚Äî completely different from Williams Selyem's Russian River wines. Tremendous aging potential.",ratings:[{score:"94",source:"Jeb Dunnuck"},{score:"92",source:"James Suckling"}],drink:"2025 ‚Äì 2030"},
  {vintage:2018,producer:"Far Niente",name:"Cave Collection Cabernet Sauvignon",region:"Oakville, Napa Valley",window:"long",type:"cab",badge:"Cabernet",background:"The Cave Collection is Far Niente's rarest offering ‚Äî library Cabernet held back and aged in their historic caves, then released years after the standard bottling. Not available on the open market; only through the Cave Club. The 2018 Napa vintage was outstanding ‚Äî warm and even, producing wines of remarkable elegance and longevity. Blend: 90.7% Cabernet Sauvignon, 6.6% Petit Verdot, 2.7% Malbec. Aged 20 months in 70% new French oak from the Stelling Vineyard in Oakville.",notes:"Cedar, black cherries, cassis, and subtle sage on the nose. Fleshy and supple on the palate with integrated acidity ‚Äî seamless, elegant, and thrilling rather than blockbuster. Ripe, building tannins on the finish with 20+ years of life ahead.",ratings:[{score:"95",source:"Wine Enthusiast"}],drink:"2026 ‚Äì 2035",special:true},
  {vintage:2023,producer:"Far Niente",name:"Cabernet Sauvignon",region:"Oakville, Napa Valley",window:"long",type:"cab",badge:"Cabernet",background:"Far Niente's flagship Cabernet ‚Äî their crown jewel since 1982. Sourced from estate vineyards in Oakville, one of Napa's most prestigious sub-AVAs, home to Screaming Eagle, Harlan, and Opus One. The 2023 vintage is considered one of Napa's strongest in recent memory with ideal growing conditions.",notes:"Classic Far Niente profile of blackcurrants, black cherry, new leather, tobacco leaf, flowers, and lead pencil. Beautifully structured with integrated acidity and ripe, building tannins. Made in a seamless, elegant style. Long, complex finish. Best from 2028 onward.",ratings:[{score:"95",source:"Wine Enthusiast (2018)"},{score:"94",source:"Wine Spectator (2022)"}],drink:"2028 ‚Äì 2038"},
  {vintage:2023,producer:"Nickel & Nickel",name:"C.C. Ranch Cabernet Sauvignon",region:"Rutherford, Napa Valley",window:"long",type:"cab",badge:"Cabernet",background:"C.C. Ranch is one of Nickel & Nickel's most celebrated vineyard sites in Rutherford. The Ranch has been in the portfolio since the winery's founding and exemplifies the Rutherford benchland style ‚Äî dense, concentrated, and structured for long aging.",notes:"Rich and chocolaty on the nose with deep, saturated black fruits. Blueberries, black cherries, and toasted oak on the palate ‚Äî dense, concentrated, and powerful with fine-grained tannins. Lush berries robed in oak spices with powdery cocoa powder and pleasing mineral lines.",ratings:[{score:"95",source:"Wine Enthusiast (2021)"},{score:"93",source:"Wine Enthusiast (2022)"}],drink:"2027 ‚Äì 2035"},
  {vintage:2023,producer:"Nickel & Nickel",name:"Element 28 Cabernet Sauvignon",region:"Lake Hennessey, Napa Valley",window:"long",type:"cab",badge:"Cabernet",background:"Named for nickel's position on the periodic table ‚Äî element 28, a nod to founder Erik Nickel. The vineyard sits in the hills above Lake Hennessey on Napa's eastern side, farmed biodynamically. 100% Cabernet Sauvignon aged 18 months in French oak.",notes:"Black currants, spearmint, and cocoa on the nose. Structured and elegant on the palate with layered dark fruit, firm tannins, and a mineral backbone from the hillside soils. Biodynamic farming imparts a distinctive purity and precision.",ratings:[{score:"91‚Äì95",source:"Wine Enthusiast (prior vintages)"}],drink:"2027 ‚Äì 2034"},
  {vintage:2018,producer:"Lasseter Family",name:"Cabernet Sauvignon",region:"Moon Mountain, Sonoma",window:"long",type:"cab",badge:"Cabernet",background:"Grown on the dramatic volcanic terrain of Trinity Ridge Estate ‚Äî nine acres of vines high atop Moon Mountain in Sonoma Valley at elevations up to 1,800 feet. Organically farmed and available only direct from the winery and select fine California restaurants. Founded by John Lasseter (Pixar/Disney) and his wife Nancy.",notes:"Aromas of cassis and graphite on the nose. The palate is brooding with deep, concentrated flavors of black plum, mocha, and dried herbs carrying through a long, velvety finish. Intense yet pure ‚Äî volcanic soils give it a distinctive mineral lift and precision that sets it apart from valley-floor Cabs.",ratings:[{score:"97",source:"Jeb Dunnuck"}],drink:"2026 ‚Äì 2033",special:true},
  {vintage:2023,producer:"Nickel & Nickel",name:"Morisoli Vineyard Cabernet Sauvignon",region:"Rutherford, Napa Valley",window:"long",type:"cab",badge:"Cabernet",background:"Nickel & Nickel's inaugural bottling from the historic Morisoli Vineyard ‚Äî one of Rutherford's most storied sites. The Morisoli family, Swiss-Italian immigrants, have farmed this land on Niebaum Lane since 1902, now in its fourth and fifth generation. The vineyard has long supplied fruit to Etude and Sequoia Grove. This is N&N's first release from the site.",notes:"A steadily moving beam of cassis and plum fruit gilded with vibrant iris and violet notes. Classic Rutherford profile on the palate with the signature dusty, mineral-edged tannins known as 'Rutherford Dust.' Structured, focused, and built for the long haul.",ratings:[{score:"TBD",source:"Scores pending ‚Äî 2023 vintage"}],drink:"2027 ‚Äì 2036",special:true},
  {vintage:2023,producer:"EnRoute",name:"Northern Spy Vineyard Pinot Noir",region:"Green Valley, Russian River Valley",window:"long",type:"pinot",badge:"Pinot Noir",background:"Northern Spy Vineyard was a former apple orchard groomed specifically for EnRoute ‚Äî the name references the Northern Spy apple variety. It sits in Green Valley, the coolest and foggiest sub-AVA within Russian River Valley, on Goldridge sandy loam soils. The combination produces wines of exceptional elegance, silky texture, and age-worthiness.",notes:"Silky, elegant, and finesse-driven ‚Äî the counterpart to Amber Ridge's darker style. Red fruits, floral notes, and a lifted aromatic quality. The Goldridge soils impart cool-climate precision and purity. Polished tannins and seamless acidity give this tremendous aging potential. Best from 2028 onward.",ratings:[{score:"95",source:"Wine Enthusiast (2022 vintage)"}],drink:"2028 ‚Äì 2040"}
];

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentFilter = 'all';
let previewData = null;

// ‚îÄ‚îÄ‚îÄ RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function getBadgeClass(t) { return {cab:'badge-cab',pinot:'badge-pinot',chard:'badge-chard',blend:'badge-blend'}[t]||''; }

function createCard(w, idx) {
  const star = w.special ? '<span class="special-dot"></span>' : '';
  const qty = w.qty || 1;
  const ratings = w.ratings && w.ratings.length
    ? `<div class="detail-label">Scores</div><div class="ratings-row">${w.ratings.map(r=>`<div class="rating-chip"><span class="rating-score">${r.score}</span><span class="rating-source">${r.source}</span></div>`).join('')}</div>`
    : '';
  const bg = w.background ? `<div class="detail-label">Background</div><p class="detail-text">${w.background}</p>` : '';
  return `<div class="wine-card ${w.window}" data-type="${w.type}" data-window="${w.window}" data-idx="${idx}" onclick="toggleCard(this)">
    <div class="card-top">
      <span class="wine-vintage">${w.vintage}</span>
      <span class="wine-badge ${getBadgeClass(w.type)}">${w.badge}</span>
    </div>
    <div class="wine-producer">${w.producer}</div>
    <div class="wine-name">${w.name}${star}</div>
    <div class="wine-region-tag">${w.region}</div>
    <div class="card-footer">
      <span class="drink-pill">${w.drink}</span>
      <div class="card-qty-controls" onclick="event.stopPropagation()">
        <button class="card-qty-btn" onclick="changeWineQty(event,${idx},-1)">‚àí</button>
        <span class="card-qty-num">${qty}</span>
        <button class="card-qty-btn" onclick="changeWineQty(event,${idx},1)">+</button>
      </div>
      <button class="card-remove-btn" onclick="deleteWine(event,${idx})" title="Remove from cellar">
        <svg width="11" height="11" viewBox="0 0 11 11" fill="none"><path d="M2 2l7 7M9 2L2 9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="wine-details">
      <div class="detail-divider"></div>
      ${bg}
      <div class="detail-label">Tasting Notes</div>
      <p class="detail-text">${w.notes}</p>
      ${ratings}
      <div class="drink-row"><span class="drink-label">Drink</span><span class="drink-range">${w.drink}</span></div>
    </div>
  </div>`;
}

function renderWines(filter = 'all') {
  currentFilter = filter;
  const g = {now:[], mid:[], long:[]};
  wines.forEach((w, i) => {
    if (filter === 'special') { if (w.special) g[w.window].push(createCard(w,i)); return; }
    const typeMatch = ['cab','pinot','chard','blend'].includes(filter) ? w.type === filter : true;
    const windowMatch = ['now','mid','long'].includes(filter) ? w.window === filter : true;
    if (typeMatch && windowMatch) g[w.window].push(createCard(w,i));
  });
  ['now','mid','long'].forEach(wn => {
    document.getElementById(`grid-${wn}`).innerHTML = g[wn].join('');
    const sec = document.getElementById(`section-${wn}`);
    const countEl = document.getElementById(`count-${wn}`);
    const total = wines.filter(w => w.window === wn).reduce((s,w) => s + (w.qty||1), 0);
    sec.style.display = g[wn].length ? 'block' : 'none';
    countEl.textContent = g[wn].length ? `${total} bottle${total !== 1 ? 's' : ''}` : '';
  });
  updateStats();
}

function updateStats() {
  const producers = new Set(wines.map(w => w.producer));
  // Map to canonical top-level regions
  const regionMap = r => {
    if (/napa/i.test(r)) return 'Napa Valley';
    if (/sonoma|russian river|green valley|moon mountain/i.test(r)) return 'Sonoma County';
    if (/anderson valley|mendocino/i.test(r)) return 'Anderson Valley';
    return r.split(',').pop().trim();
  };
  const regions = new Set(wines.map(w => regionMap(w.region)));
  const totalBottles = wines.reduce((s, w) => s + (w.qty || 1), 0);
  document.getElementById('stat-bottles').textContent = totalBottles;
  document.getElementById('stat-producers').textContent = producers.size;
  document.getElementById('stat-regions').textContent = regions.size;
}

// ‚îÄ‚îÄ‚îÄ QTY CHANGE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function changeWineQty(e, idx, delta) {
  e.stopPropagation();
  wines[idx].qty = Math.max(1, (wines[idx].qty || 1) + delta);
  const card = document.querySelector(`.wine-card[data-idx="${idx}"]`);
  if (card) card.querySelector('.card-qty-num').textContent = wines[idx].qty;
  updateStats();
  ['now','mid','long'].forEach(wn => {
    const countEl = document.getElementById(`count-${wn}`);
    const total = wines.filter(w => w.window === wn).reduce((s,w) => s + (w.qty||1), 0);
    if (countEl && countEl.textContent) countEl.textContent = `${total} bottle${total !== 1 ? 's' : ''}`;
  });
  persist();
}

// ‚îÄ‚îÄ‚îÄ CARD TOGGLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function toggleCard(card) {
  const was = card.classList.contains('expanded');
  document.querySelectorAll('.wine-card.expanded').forEach(c => c.classList.remove('expanded'));
  if (!was) card.classList.add('expanded');
}

// ‚îÄ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function deleteWine(e, idx) {
  e.stopPropagation();
  if (!confirm('Remove this bottle from your cellar?')) return;
  wines.splice(idx, 1);
  renderWines(currentFilter);
  updateMapPins();
  persist();
}

// ‚îÄ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function filterWines(f, btn) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  renderWines(f);
}

// ‚îÄ‚îÄ‚îÄ TABS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(tab, btn) {
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById(`panel-${tab}`).classList.add('active');
}

function switchTabMobile(tab) {
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.getElementById(`panel-${tab}`).classList.add('active');
  document.querySelectorAll('.mobile-tab').forEach(b => b.classList.remove('active'));
  const mtab = document.getElementById(`mtab-${tab}`);
  if (mtab) mtab.classList.add('active');
  // Sync desktop tabs too
  document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
  const tabMap = { cellar: 0, wishlist: 1, map: 2 };
  const tabs = document.querySelectorAll('.tab');
  if (tabs[tabMap[tab]]) tabs[tabMap[tab]].classList.add('active');
}

// ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openModal() {
  document.getElementById('modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('wine-search').focus(), 100);
}

function closeModal() {
  document.getElementById('modal').classList.remove('open');
  document.body.style.overflow = '';
  resetModal();
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('modal')) closeModal();
}

function resetModal() {
  document.getElementById('wine-search').value = '';
  document.getElementById('search-status').textContent = '';
  document.getElementById('search-status').className = 'search-status';
  document.getElementById('wine-preview').classList.remove('visible');
  document.getElementById('form-section').style.display = 'none';
  document.getElementById('btn-submit').disabled = true;
  previewData = null;
  ['f-producer','f-vintage','f-name','f-region','f-drink','f-notes','f-background'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = '';
  });
  const qtyEl = document.getElementById('f-qty');
  if (qtyEl) qtyEl.value = '1';
  document.getElementById('f-special').checked = false;
}

// ‚îÄ‚îÄ‚îÄ AI ROUTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Routes to Netlify/Gemini when hosted, Anthropic directly when local/preview
async function callAI({ system, prompt, maxTokens = 1000 }) {
  const isNetlify = window.location.hostname.includes('netlify.app') ||
                    window.location.hostname.includes('netlify.com');

  if (isNetlify) {
    // Call our Netlify proxy function ‚Üí Gemini
    const res = await fetch('/.netlify/functions/claude', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ system, prompt, maxTokens })
    });
    if (!res.ok) throw new Error(`Proxy error: ${res.status}`);
    const data = await res.json();
    return data.text;
  } else {
    // Direct Anthropic call (local / Claude.ai preview)
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: maxTokens,
        system,
        messages: [{ role: 'user', content: prompt }]
      })
    });
    if (!res.ok) throw new Error(`Anthropic error: ${res.status}`);
    const data = await res.json();
    return data.content?.map(c => c.text || '').join('') || '';
  }
}

// ‚îÄ‚îÄ‚îÄ AI SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function searchWine() {
  const query = document.getElementById('wine-search').value.trim();
  if (!query) return;
  
  const btn = document.getElementById('btn-search');
  const status = document.getElementById('search-status');
  
  btn.disabled = true;
  btn.textContent = 'Searching‚Ä¶';
  btn.classList.add('loading');
  status.textContent = 'Looking up wine details‚Ä¶';
  status.className = 'search-status searching';
  document.getElementById('wine-preview').classList.remove('visible');
  document.getElementById('form-section').style.display = 'none';
  document.getElementById('btn-submit').disabled = true;

  try {
    const systemPrompt = `You are a wine expert assistant. When given a wine query, respond ONLY with a JSON object containing wine details. No other text.

JSON format:
{
  "producer": "producer name",
  "name": "wine name (without producer and vintage)",
  "vintage": 2021,
  "region": "specific region/appellation",
  "type": "cab|pinot|chard|blend",
  "badge": "Cabernet|Pinot Noir|Chardonnay|Blend",
  "window": "now|mid|long",
  "drink": "drink window e.g. 2025 ‚Äì 2032",
  "notes": "professional-quality tasting notes, 2-3 sentences",
  "background": "winery/vineyard background, 2-3 sentences",
  "ratings": [{"score": "93", "source": "Wine Spectator"}],
  "special": false
}

If vintage is not specified, use a recent notable vintage. Make reasonable inferences for all fields. The "window" field must be one of: "now" (drink within 1-2 years), "mid" (2-5 years), "long" (5+ years). RESPOND WITH VALID JSON ONLY.`;

    const response = await callAI({ system: systemPrompt, prompt: `Wine query: ${query}`, maxTokens: 1000 });
    const text = response;
    
    // Clean and parse JSON
    const clean = text.replace(/```json|```/g, '').trim();
    const wine = JSON.parse(clean);
    
    previewData = wine;
    showPreview(wine);
    populateForm(wine);
    
    status.textContent = '‚úì Wine found ‚Äî review details below';
    status.className = 'search-status found';
    document.getElementById('btn-submit').disabled = false;

  } catch (err) {
    console.error(err);
    status.textContent = 'Could not fetch details ‚Äî fill in manually below';
    status.className = 'search-status error';
    document.getElementById('form-section').style.display = 'block';
    document.getElementById('btn-submit').disabled = false;
  } finally {
    btn.disabled = false;
    btn.innerHTML = `<svg width="13" height="13" viewBox="0 0 13 13" fill="none"><circle cx="5.5" cy="5.5" r="4" stroke="currentColor" stroke-width="1.5"/><path d="M9 9l2.5 2.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg> Search`;
    btn.classList.remove('loading');
  }
}

function showPreview(w) {
  document.getElementById('prev-producer').textContent = w.producer;
  document.getElementById('prev-name').textContent = `${w.vintage} ${w.name}`;
  document.getElementById('prev-region').textContent = w.region;
  document.getElementById('prev-vintage-bg').textContent = w.vintage;
  document.getElementById('prev-notes').textContent = w.notes || '‚Äî';
  document.getElementById('prev-drink').textContent = w.drink || '‚Äî';
  
  const badge = document.getElementById('prev-badge');
  badge.textContent = w.badge;
  badge.className = `preview-badge ${getBadgeClass(w.type)}`;
  
  const ratingsEl = document.getElementById('prev-ratings');
  if (w.ratings && w.ratings.length) {
    ratingsEl.innerHTML = w.ratings.map(r => `<div class="rating-chip"><span class="rating-score">${r.score}</span><span class="rating-source">${r.source}</span></div>`).join('');
    document.getElementById('prev-ratings-section').style.display = 'block';
  } else {
    document.getElementById('prev-ratings-section').style.display = 'none';
  }
  
  document.getElementById('wine-preview').classList.add('visible');
  document.getElementById('form-section').style.display = 'block';
}

function populateForm(w) {
  document.getElementById('f-producer').value = w.producer || '';
  document.getElementById('f-vintage').value = w.vintage || '';
  document.getElementById('f-name').value = w.name || '';
  document.getElementById('f-region').value = w.region || '';
  document.getElementById('f-drink').value = w.drink || '';
  document.getElementById('f-notes').value = w.notes || '';
  document.getElementById('f-background').value = w.background || '';
  document.getElementById('f-special').checked = !!w.special;
  
  const typeSelect = document.getElementById('f-type');
  if (w.type) typeSelect.value = w.type;
  
  const windowSelect = document.getElementById('f-window');
  if (w.window) windowSelect.value = w.window;
}

// ‚îÄ‚îÄ‚îÄ ADD BOTTLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function addBottle() {
  const producer = document.getElementById('f-producer').value.trim();
  const vintage = parseInt(document.getElementById('f-vintage').value);
  const name = document.getElementById('f-name').value.trim();
  
  if (!producer || !vintage || !name) {
    alert('Please fill in at least Producer, Vintage, and Wine Name.');
    return;
  }
  
  const type = document.getElementById('f-type').value;
  const badgeMap = {cab:'Cabernet',pinot:'Pinot Noir',chard:'Chardonnay',blend:'Blend'};
  
  const newWine = {
    vintage,
    producer,
    name,
    region: document.getElementById('f-region').value || 'California',
    window: document.getElementById('f-window').value,
    type,
    badge: badgeMap[type],
    background: document.getElementById('f-background').value || '',
    notes: document.getElementById('f-notes').value || '',
    ratings: [],
    drink: document.getElementById('f-drink').value || 'TBD',
    qty: Math.max(1, parseInt(document.getElementById('f-qty').value) || 1),
    special: document.getElementById('f-special').checked
  };
  
  wines.unshift(newWine);
  renderWines(currentFilter);
  updateMapPins();
  persist();
  closeModal();
  
  // Flash the new card briefly
  setTimeout(() => {
    const firstCard = document.querySelector(`#grid-${newWine.window} .wine-card`);
    if (firstCard) {
      firstCard.style.transition = 'box-shadow 0.4s, border-color 0.4s';
      firstCard.style.boxShadow = '0 0 0 3px rgba(122,48,16,0.2)';
      firstCard.style.borderColor = 'var(--accent)';
      setTimeout(() => {
        firstCard.style.boxShadow = '';
        firstCard.style.borderColor = '';
      }, 1800);
    }
  }, 100);
}



// ‚îÄ‚îÄ‚îÄ MAILING LISTS DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const mailingLists = [
  {
    id: 'ws',
    producer: 'Williams Selyem',
    type: 'active',
    description: 'Mailing list ¬∑ 2 releases/year',
    commitment: 'Voluntary',
    currentRelease: 'Spring 2026',
    shipments: [
      { label:'Spring', month:2, note:'AVA & appellation wines ¬∑ ~Feb order, ships Mar' },
      { label:'Fall',   month:8, note:'Vineyard designates ¬∑ ~Aug order, ships Nov' }
    ],
    history: [
      { label:'Spring 2026', bottles:7, spend:621 }
    ]
  },
  {
    id: 'fn',
    producer: 'Far Niente / House of FN',
    type: 'active',
    description: 'Dolce Far Niente Society ¬∑ 4 shipments/year',
    commitment: 'Required ¬∑ $400‚Äì615/shipment',
    currentRelease: 'April 2026',
    shipments: [
      { label:'February', month:2,  note:'FN, N&N, EnRoute, Bella Union + Cave Collection' },
      { label:'April',    month:4,  note:'FN, N&N, EnRoute, Bella Union + Cave Collection' },
      { label:'October',  month:10, note:'FN, N&N, EnRoute, Bella Union + Cave Collection' },
      { label:'December', month:12, note:'FN, N&N, EnRoute, Bella Union + Cave Collection' }
    ],
    history: []
  },
  {
    id: 'littorai',
    producer: 'Littorai',
    type: 'watching',
    description: 'Mailing list ¬∑ 2 releases/year',
    commitment: 'Optional ¬∑ $80‚Äì115/bottle',
    currentRelease: 'Winter 2026',
    shipments: [
      { label:'Winter', month:1, note:'January ‚Äî first-come, first-served' },
      { label:'Fall',   month:8, note:'August ‚Äî vineyard designates, sells out fast' }
    ],
    history: []
  }
];

// Which month is "upcoming" or "open" ‚Äî within 6 weeks = upcoming, within 2 weeks = open
function getShipmentStatus(monthNum) {
  const now = new Date();
  const currentMonth = now.getMonth() + 1;
  const diff = monthNum - currentMonth;
  if (diff === 0) return 'open';
  if (diff === 1 || diff === -11) return 'upcoming';
  return 'normal';
}

function renderLists() {
  const grid = document.getElementById('lists-grid');
  grid.innerHTML = mailingLists.map(list => {
    const shipmentPips = list.shipments.map(s => {
      const status = getShipmentStatus(s.month);
      return `<span class="shipment-pip ${status}" title="${s.note}">${s.label}</span>`;
    }).join('');

    const historyHtml = list.history.length ? `
      <div class="list-history">
        <div class="list-history-label">Past Sessions</div>
        ${list.history.map(h => `
          <div class="history-item">
            <span>${h.label}</span>
            <span>${h.bottles} bottles ¬∑ $${h.spend.toLocaleString()}</span>
          </div>
        `).join('')}
      </div>` : '';

    const sessionBtn = `<button class="btn-session" onclick="openSessionModal('${list.id}')">
      <svg width="12" height="12" viewBox="0 0 12 12" fill="none"><path d="M6 1v5l3 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><circle cx="6" cy="6" r="5" stroke="currentColor" stroke-width="1.4"/></svg>
      Start Buying Session
    </button>`;

    return `
      <div class="list-card ${list.type}-list">
        <div class="list-card-top">
          <div class="list-producer">${list.producer}</div>
          <span class="list-type-tag ${list.type === 'active' ? 'tag-active' : 'tag-watching'}">${list.type === 'active' ? 'Active' : 'Watching'}</span>
        </div>
        <div class="list-meta">
          <strong>${list.description}</strong><br>
          ${list.commitment}
        </div>
        <div class="list-shipments">${shipmentPips}</div>
        <div class="list-actions">${sessionBtn}</div>
        ${historyHtml}
      </div>`;
  }).join('');
}

// ‚îÄ‚îÄ‚îÄ BUYING SESSION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let currentSessionListId = null;
let sessionAnalysis = []; // [{name, price, rec, note, qty, type, region, vintage}]

function openSessionModal(listId) {
  currentSessionListId = listId;
  const list = mailingLists.find(l => l.id === listId);
  document.getElementById('session-title').textContent = `${list.producer} ‚Äî Buying Session`;
  document.getElementById('session-subtitle').textContent = list.description;

  // Show cellar context note
  const currentBottles = wines.filter(w => w.producer.toLowerCase().includes(list.producer.split(' ')[0].toLowerCase()));
  const note = currentBottles.length
    ? `You have ${currentBottles.length} bottle${currentBottles.length>1?'s':''} from this producer in your cellar already.`
    : '';
  document.getElementById('session-context-note').textContent = note;

  // Reset state
  document.getElementById('session-paste').value = '';
  document.getElementById('analysis-results').classList.remove('visible');
  document.getElementById('analyzing-state').style.display = 'none';
  document.getElementById('btn-add-session').style.display = 'none';
  document.getElementById('session-spend').style.display = 'none';
  document.getElementById('btn-analyze').disabled = false;
  sessionAnalysis = [];

  document.getElementById('session-modal').classList.add('open');
  document.body.style.overflow = 'hidden';
  setTimeout(() => document.getElementById('session-paste').focus(), 100);
}

function closeSessionModal() {
  document.getElementById('session-modal').classList.remove('open');
  document.body.style.overflow = '';
}

function handleSessionOverlayClick(e) {
  if (e.target === document.getElementById('session-modal')) closeSessionModal();
}

async function analyzeAllocation() {
  const pasteText = document.getElementById('session-paste').value.trim();
  if (!pasteText) { alert('Please paste your allocation list first.'); return; }

  const list = mailingLists.find(l => l.id === currentSessionListId);

  // Build cellar context
  const cellarSummary = wines.map(w => `${w.vintage} ${w.producer} ${w.name} (${w.window}, qty:${w.qty||1})`).join('\n');
  const alreadyConsidering = wishlist.map(w => `${w.vintage} ${w.producer} ${w.name}`).join('\n');

  document.getElementById('btn-analyze').disabled = true;
  document.getElementById('analyzing-state').style.display = 'block';
  document.getElementById('analysis-results').classList.remove('visible');

  // Per-producer buying targets
  const bottleTargets = {
    'Williams Selyem': { target: 6, guidance: 'Target around 6 bottles total. Be selective ‚Äî prioritize the most distinctive vineyard-designate wines over broader AVA wines. Quality over volume; recommend passing on anything that doesn\'t clearly earn its place.' },
    'Far Niente / House of FN': { target: 4, guidance: 'Target around 4 bottles per shipment ‚Äî this is a required club so budget discipline is helpful. Prioritize the most compelling wines but use judgment; if 5 are genuinely excellent it\'s fine to go to 5. Quality over volume.' },
    'Littorai': { target: 4, guidance: 'This is a watch list ‚Äî be conservative. Recommend 3-5 bottles maximum, only the most compelling vineyard-designates. The collector hasn\'t committed to this list yet so the bar should be higher.' }
  };
  const targetInfo = bottleTargets[list.producer] || { target: 6, guidance: 'Be selective and quality-focused. Prioritize distinctive wines over volume.' };

  try {
    const systemPrompt = `You are an expert wine advisor helping a collector decide which wines to order from their ${list.producer} allocation.

The collector's current cellar contains:
${cellarSummary || 'Nothing yet'}

They are already considering ordering:
${alreadyConsidering || 'Nothing yet'}

BUYING GUIDELINES FOR THIS PRODUCER:
${targetInfo.guidance}
Total bottle target: ~${targetInfo.target} bottles across all "buy" recommendations combined (suggestedQty totals should add up to approximately ${targetInfo.target}).
Price is NOT a reason to buy ‚Äî only recommend if the wine is genuinely excellent and distinctive. A $120 wine that's exceptional beats two $60 wines that are merely good.
Be willing to recommend "pass" on a majority of the list if warranted. "Consider" should mean real uncertainty, not a soft buy.

Analyze the allocation list and for EACH wine provide a recommendation. Be direct and opinionated. Consider: distinctiveness of the vineyard, how it fits or overlaps with what they already have, aging potential, and genuine quality.

Respond ONLY with a JSON object in this exact format:
{
  "summary": "2-3 sentence overall take on this release and buying strategy ‚Äî mention the target bottle count and your overall approach",
  "wines": [
    {
      "name": "wine name without producer",
      "vintage": 2024,
      "price": 90,
      "type": "pinot|cab|chard|blend",
      "region": "region or appellation",
      "rec": "buy|consider|pass",
      "suggestedQty": 1,
      "note": "1-2 sentence take ‚Äî specific, direct, no fluff. Why this wine earns its spot or doesn't."
    }
  ]
}

rec must be exactly: "buy", "consider", or "pass"
suggestedQty: 0 for pass, 1-2 for consider, 1-3 for buy ‚Äî but total buy quantities should not exceed ${targetInfo.target}.
RESPOND WITH VALID JSON ONLY. No markdown, no preamble.`;

    const text = await callAI({ system: systemPrompt, prompt: `Allocation list:\n${pasteText}`, maxTokens: 2000 });
    const clean = text.replace(/```json|```/g, '').trim();
    const result = JSON.parse(clean);

    sessionAnalysis = result.wines.map(w => ({...w, qty: w.rec === 'pass' ? 0 : (w.suggestedQty || 1)}));
    renderAnalysis(result.summary, sessionAnalysis, list.producer);

  } catch (err) {
    console.error(err);
    document.getElementById('analyzing-state').style.display = 'none';
    alert('Analysis failed ‚Äî check your connection and try again.');
    document.getElementById('btn-analyze').disabled = false;
  }
}

function renderAnalysis(summary, wines_list, producer) {
  document.getElementById('analyzing-state').style.display = 'none';

  document.getElementById('analysis-summary').innerHTML = summary;

  document.getElementById('analysis-list').innerHTML = wines_list.map((w, i) => {
    const recLabel = { buy:'Strong Buy', consider:'Consider', pass:'Pass' }[w.rec] || w.rec;
    return `
      <div class="analysis-row rec-${w.rec}" id="arow-${i}">
        <div>
          <div class="analysis-wine-name">${producer} ${w.name}${w.vintage ? ` <span style="opacity:0.5;font-size:13px;">${w.vintage}</span>` : ''}</div>
          <div class="analysis-price">${w.region || ''}${w.price ? ` ¬∑ $${w.price}` : ''}</div>
          <div class="analysis-note">${w.note}</div>
        </div>
        <span class="rec-badge ${w.rec}">${recLabel}</span>
        <div class="analysis-qty-wrap">
          <button class="analysis-qty-btn" onclick="changeSessionQty(${i},-1)">‚àí</button>
          <span class="analysis-qty-num" id="aqty-${i}">${w.qty}</span>
          <button class="analysis-qty-btn" onclick="changeSessionQty(${i},1)">+</button>
        </div>
      </div>`;
  }).join('');

  document.getElementById('analysis-results').classList.add('visible');
  document.getElementById('btn-add-session').style.display = 'flex';
  document.getElementById('session-spend').style.display = 'block';
  updateSessionSpend();
}

function changeSessionQty(idx, delta) {
  sessionAnalysis[idx].qty = Math.max(0, sessionAnalysis[idx].qty + delta);
  document.getElementById(`aqty-${idx}`).textContent = sessionAnalysis[idx].qty;
  // If qty set to 0, dim the row
  const row = document.getElementById(`arow-${idx}`);
  row.style.opacity = sessionAnalysis[idx].qty === 0 ? '0.45' : '1';
  updateSessionSpend();
}

function updateSessionSpend() {
  const total = sessionAnalysis.reduce((s, w) => s + (w.price || 0) * w.qty, 0);
  document.getElementById('session-spend-amt').textContent = total ? `$${total.toLocaleString()}` : '$0';
}

function addSessionToShortlist() {
  const list = mailingLists.find(l => l.id === currentSessionListId);
  const toAdd = sessionAnalysis.filter(w => w.qty > 0);
  if (!toAdd.length) { alert('No bottles selected ‚Äî adjust quantities first.'); return; }

  const badgeMap = {cab:'Cabernet',pinot:'Pinot Noir',chard:'Chardonnay',blend:'Blend'};
  const sourceLabel = `${list.producer} ‚Äî ${list.currentRelease || new Date().toLocaleDateString('en-US',{month:'long',year:'numeric'})}`;
  toAdd.forEach(w => {
    // If this wine already exists in shortlist from same source, just update qty
    const existing = wishlist.find(x => x.source === sourceLabel && x.name === w.name && x.vintage === (w.vintage || new Date().getFullYear()));
    if (existing) {
      existing.qty = w.qty;
    } else {
      wishlist.push({
        producer: list.producer,
        name: w.name,
        vintage: w.vintage || new Date().getFullYear(),
        type: w.type || 'pinot',
        badge: badgeMap[w.type] || 'Wine',
        region: w.region || '',
        price: w.price || 0,
        qty: w.qty,
        source: sourceLabel
      });
    }
  });

  // Save to history
  const totalSpend = toAdd.reduce((s,w) => s + (w.price||0) * w.qty, 0);
  const totalBottles = toAdd.reduce((s,w) => s + w.qty, 0);
  const listObj = mailingLists.find(l => l.id === currentSessionListId);
  const sessionLabel = list.currentRelease || new Date().toLocaleDateString('en-US',{month:'long',year:'numeric'});
  listObj.history = listObj.history.filter(h => h.label !== sessionLabel);
  listObj.history.unshift({ label: sessionLabel, bottles: totalBottles, spend: totalSpend });

  renderWishlist();
  renderLists();
  persist();
  closeSessionModal();

  // Switch to wishlist tab
  const wishTab = document.querySelectorAll('.tab')[1];
  switchTab('wishlist', wishTab);
}

// ‚îÄ‚îÄ‚îÄ WISHLIST DATA ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let wishlist = [
  { producer:"Williams Selyem", name:"Westside Road Neighbors Pinot Noir", vintage:2024, type:"pinot", badge:"Pinot Noir", region:"Russian River Valley", price:90, qty:3, source:"Williams Selyem ‚Äî Spring 2026" },
  { producer:"Williams Selyem", name:"Olivet Lane Vineyard Pinot Noir",    vintage:2024, type:"pinot", badge:"Pinot Noir", region:"Russian River Valley", price:90, qty:1, source:"Williams Selyem ‚Äî Spring 2026" },
  { producer:"Williams Selyem", name:"Lewis MacGregor Estate Pinot Noir",  vintage:2023, type:"pinot", badge:"Pinot Noir", region:"Russian River Valley", price:125, qty:1, source:"Williams Selyem ‚Äî Spring 2026" },
  { producer:"Williams Selyem", name:"Heintz Vineyard Chardonnay",         vintage:2024, type:"chard", badge:"Chardonnay", region:"Russian River Valley", price:68, qty:1, source:"Williams Selyem ‚Äî Spring 2026" },
  { producer:"Williams Selyem", name:"Drake Estate Vineyard Chardonnay",   vintage:2024, type:"chard", badge:"Chardonnay", region:"Russian River Valley", price:68, qty:1, source:"Williams Selyem ‚Äî Spring 2026" },
];

function renderWishlist() {
  const content = document.getElementById('wishlist-content');
  if (!wishlist.length) {
    content.innerHTML = `<div class="wishlist-empty"><svg width="32" height="32" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="14" stroke="currentColor" stroke-width="1.5"/><path d="M10 16h12M16 10v12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg><p>Nothing here yet ‚Äî add bottles you're considering</p></div>`;
    updateWishSummary();
    return;
  }

  // Group by source
  const groups = {};
  wishlist.forEach((w, i) => {
    if (!groups[w.source]) groups[w.source] = [];
    groups[w.source].push({...w, idx: i});
  });

  content.innerHTML = Object.entries(groups).map(([source, items]) => `
    <div class="source-group">
      <div class="source-header">
        <span class="source-label">From</span>
        <span class="source-name">${source}</span>
        <span class="source-count">${items.reduce((s,w)=>s+w.qty,0)} bottles ¬∑ $${items.reduce((s,w)=>s+w.price*w.qty,0).toLocaleString()}</span>
      </div>
      <div class="wishlist-table">
        ${items.map(w => `
          <div class="wish-row" data-idx="${w.idx}">
            <div class="wish-vintage">${w.vintage}</div>
            <div class="wish-info">
              <div class="wish-name">${w.producer} ${w.name}</div>
              <div class="wish-sub">
                <span class="wish-badge ${getBadgeClass(w.type)}">${w.badge}</span>
                ${w.region}
              </div>
            </div>
            <div class="wish-price">$${w.price} ea</div>
            <div class="wish-qty">
              <button class="qty-btn" onclick="changeQty(${w.idx},-1)">‚àí</button>
              <span class="qty-num">${w.qty}</span>
              <button class="qty-btn" onclick="changeQty(${w.idx},1)">+</button>
            </div>
            <div class="wish-actions">
              <button class="wish-btn wish-btn-add" onclick="moveTocellar(${w.idx})">
                <svg width="11" height="11" viewBox="0 0 11 11" fill="none"><path d="M5.5 1v9M1 5.5h9" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/></svg>
                Add to Cellar
              </button>
              <button class="wish-btn wish-btn-remove" onclick="removeFromWishlist(${w.idx})">Remove</button>
            </div>
          </div>
        `).join('')}
      </div>
    </div>
  `).join('');

  updateWishSummary();
}

function updateWishSummary() {
  const totalBottles = wishlist.reduce((s,w) => s + w.qty, 0);
  const totalCost = wishlist.reduce((s,w) => s + w.price * w.qty, 0);
  document.getElementById('wish-count').textContent = totalBottles;
  document.getElementById('wish-total').textContent = '$' + totalCost.toLocaleString();

  // Badge on tab
  const badge = document.getElementById('wish-tab-badge');
  const mobileBadge = document.getElementById('wish-mobile-badge');
  if (totalBottles > 0) {
    badge.textContent = totalBottles;
    badge.style.display = 'inline';
    if (mobileBadge) { mobileBadge.textContent = totalBottles; mobileBadge.style.display = 'flex'; }
  } else {
    badge.style.display = 'none';
    if (mobileBadge) mobileBadge.style.display = 'none';
  }
}

function changeQty(idx, delta) {
  wishlist[idx].qty = Math.max(1, wishlist[idx].qty + delta);
  renderWishlist();
  persist();
}

function removeFromWishlist(idx) {
  wishlist.splice(idx, 1);
  renderWishlist();
  persist();
}

// Map producer name ‚Üí pin/label IDs
const producerPinMap = {
  'Williams Selyem': ['pin-williams-selyem', 'label-williams-selyem'],
  'EnRoute':         ['pin-enroute',         'label-enroute'],
  'Lasseter Family': ['pin-lasseter',        'label-lasseter'],
  'Far Niente':      ['pin-far-niente',      'label-far-niente'],
  'Bella Union':     ['pin-bella-union',     'label-bella-union'],
  'Opus One':        ['pin-opus-one',        'label-opus-one'],
  'Nickel & Nickel': ['pin-nickel',          'label-nickel'],
};

function updateMapPins() {
  // Count bottles per producer in collection
  const counts = {};
  wines.forEach(w => { counts[w.producer] = (counts[w.producer] || 0) + (w.qty || 1); });

  Object.entries(producerPinMap).forEach(([producer, ids]) => {
    const hasBottles = (counts[producer] || 0) > 0;
    ids.forEach(id => {
      const el = document.getElementById(id);
      if (el) el.style.opacity = hasBottles ? '1' : '0.28';
    });
  });
}

function moveTocellar(idx) {
  const w = wishlist[idx];
  const windowMap = { pinot:'mid', chard:'now', cab:'long', blend:'mid' };
  const drinkMap = {
    pinot: `${w.vintage + 2} ‚Äì ${w.vintage + 7}`,
    chard: `Now ‚Äì ${w.vintage + 3}`,
    cab:   `${w.vintage + 4} ‚Äì ${w.vintage + 12}`,
    blend: `${w.vintage + 2} ‚Äì ${w.vintage + 7}`
  };
  const badgeMap = {cab:'Cabernet',pinot:'Pinot Noir',chard:'Chardonnay',blend:'Blend'};

  wines.unshift({
    vintage: w.vintage,
    producer: w.producer,
    name: w.name,
    region: w.region,
    window: windowMap[w.type] || 'mid',
    type: w.type,
    badge: badgeMap[w.type] || w.badge,
    qty: w.qty || 1,
    notes: '',
    background: '',
    ratings: [],
    drink: drinkMap[w.type] || 'TBD',
    special: false
  });

  wishlist.splice(idx, 1);
  renderWishlist();
  renderWines(currentFilter);
  updateMapPins();
  persist();
  showToast(`${w.producer} ${w.name} added to cellar`);
}

function showToast(msg) {
  let t = document.getElementById('toast');
  if (!t) {
    t = document.createElement('div');
    t.id = 'toast';
    t.style.cssText = `position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(12px);
      background:var(--text);color:#fefcf9;padding:10px 20px;border-radius:4px;
      font-family:'Outfit',sans-serif;font-size:12px;font-weight:400;letter-spacing:0.3px;
      opacity:0;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);z-index:9999;white-space:nowrap;
      box-shadow:var(--shadow-md);pointer-events:none;`;
    document.body.appendChild(t);
  }
  t.textContent = msg;
  requestAnimationFrame(() => {
    t.style.opacity = '1';
    t.style.transform = 'translateX(-50%) translateY(0)';
  });
  clearTimeout(t._timer);
  t._timer = setTimeout(() => {
    t.style.opacity = '0';
    t.style.transform = 'translateX(-50%) translateY(8px)';
  }, 2800);
}

// ‚îÄ‚îÄ‚îÄ PERSISTENCE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const STORAGE_KEYS = { wines: 'cuvee_wines', wishlist: 'cuvee_wishlist', lists: 'cuvee_lists' };

function persist() {
  try {
    localStorage.setItem(STORAGE_KEYS.wines,    JSON.stringify(wines));
    localStorage.setItem(STORAGE_KEYS.wishlist, JSON.stringify(wishlist));
    localStorage.setItem(STORAGE_KEYS.lists,    JSON.stringify(mailingLists.map(l => ({ id: l.id, history: l.history, currentRelease: l.currentRelease }))));
  } catch(e) { console.warn('Could not save to localStorage:', e); }
}

function loadPersistedData() {
  try {
    const savedWines = localStorage.getItem(STORAGE_KEYS.wines);
    if (savedWines) {
      const parsed = JSON.parse(savedWines);
      // Merge: keep saved wines, but add any hardcoded wines not already present
      const defaultWines = [...wines];
      wines.length = 0;
      parsed.forEach(w => wines.push(w));
      // Add any hardcoded wines missing from saved data (new additions)
      defaultWines.forEach(dw => {
        const exists = wines.some(w => w.producer === dw.producer && w.name === dw.name && w.vintage === dw.vintage);
        if (!exists) wines.push(dw);
      });
    }
    const savedWishlist = localStorage.getItem(STORAGE_KEYS.wishlist);
    if (savedWishlist) {
      wishlist.length = 0;
      JSON.parse(savedWishlist).forEach(w => wishlist.push(w));
    }
    const savedLists = localStorage.getItem(STORAGE_KEYS.lists);
    if (savedLists) {
      JSON.parse(savedLists).forEach(saved => {
        const list = mailingLists.find(l => l.id === saved.id);
        if (list) {
          list.history = saved.history;
          if (saved.currentRelease) list.currentRelease = saved.currentRelease;
        }
      });
    }
  } catch(e) { console.warn('Could not load from localStorage:', e); }
}

// ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
wines.forEach(w => { if (!w.qty) w.qty = 1; });
loadPersistedData();
renderWines();
renderWishlist();
renderLists();
updateMapPins();

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    if (document.getElementById('session-modal').classList.contains('open')) closeSessionModal();
    if (document.getElementById('modal').classList.contains('open')) closeModal();
  }
});
</script>
</body>
</html>
